<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>MAKROTEKS Teknik Rapor - Bulut Ar≈üivi</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; }
        .ana-konteyner { max-width: 1250px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .input-alan { border: 1px solid #94a3b8; padding: 6px 10px; border-radius: 4px; width: 100%; font-size: 14px; }
        .etiket { font-weight: bold; font-size: 11px; color: #475569; text-transform: uppercase; margin-bottom: 2px; }
        @media print { .no-print { display: none !important; } .ana-konteyner { box-shadow: none; border: none; width: 100%; } }
        #connStatus { font-size: 12px; color: green; font-weight: bold; float: right; }
    </style>
</head>
<body class="p-4">

<div class="ana-konteyner">
    <div id="connStatus">‚óè Bulut Baƒülantƒ±sƒ± Aktif</div>
    <h1 class="text-2xl font-extrabold text-blue-900 border-b-4 border-blue-600 pb-2 mb-6">üìâ TEKNƒ∞K KUMA≈û ANALƒ∞Z RAPORU</h1>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 no-print bg-slate-50 p-6 rounded-xl border border-slate-200 shadow-sm mb-8">
        <input type="hidden" id="edit_id">
        
        <div class="md:col-span-1 flex flex-col items-center justify-center border-2 border-dashed border-slate-300 rounded-lg p-2 bg-white relative h-48 cursor-pointer overflow-hidden" onclick="document.getElementById('fileInput').click()">
            <span id="plusSign" class="text-4xl text-slate-300">+</span>
            <img id="previewImg" class="hidden absolute inset-0 w-full h-full object-cover">
            <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="resimSec(this)">
        </div>

        <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div><label class="etiket">M√º≈üteri / Firma</label><input type="text" id="musteri" class="input-alan"></div>
            <div><label class="etiket">Kuma≈ü Cinsi</label><input type="text" id="kumas_cinsi" class="input-alan"></div>
            <div><label class="etiket">Pus / Feyn / ƒ∞ƒüne</label><input type="text" id="makine_bilgi" class="input-alan" placeholder="32 / 28 / 2880"></div>
            <div><label class="etiket">Gramaj (m2)</label><input type="text" id="gramaj" class="input-alan"></div>
            <div><label class="etiket">May Boyu</label><input type="text" id="may_boyu" class="input-alan"></div>
            <div><label class="etiket">Tarih</label><input type="date" id="tarih" class="input-alan"></div>
        </div>

        <div class="md:col-span-4">
            <label class="etiket">ƒ∞plik Kompozisyonu ve Makine Ayarlarƒ±</label>
            <textarea id="notlar" class="input-alan h-20" placeholder="√ñrn: 30/1 Penye %96, 20 Denye Elastan %4... L√ºper ayarƒ±: 2.4mm"></textarea>
        </div>

        <div class="md:col-span-4 flex gap-2">
            <button onclick="kaydet()" id="anaButon" class="flex-1 bg-blue-700 text-white font-bold py-3 rounded-lg hover:bg-blue-800 transition">BULUTA G√ñNDER / G√úNCELLE</button>
            <button onclick="formTemizle()" class="bg-slate-500 text-white px-6 rounded-lg font-bold">TEMƒ∞ZLE</button>
        </div>
    </div>

    <div class="no-print mb-4">
        <input type="text" id="arama" onkeyup="listele()" placeholder="M√º≈üteri veya kuma≈ü cinsine g√∂re ara..." class="w-full p-3 border-2 border-blue-100 rounded-lg shadow-inner">
    </div>

    <div class="overflow-x-auto">
        <table class="w-full border-collapse bg-white shadow-sm rounded-lg overflow-hidden">
            <thead class="bg-blue-900 text-white text-xs uppercase">
                <tr>
                    <th class="p-3">G√∂rsel</th>
                    <th class="p-3 text-left">M√º≈üteri / Kuma≈ü</th>
                    <th class="p-3">Makine / Gr</th>
                    <th class="p-3">May Boyu</th>
                    <th class="p-3">Tarih</th>
                    <th class="p-3 no-print">ƒ∞≈ülem</th>
                </tr>
            </thead>
            <tbody id="raporListesi"></tbody>
        </table>
    </div>
</div>

<script>
    // Fƒ∞REBASE YAPILANDIRMASI
    const firebaseConfig = {
        apiKey: "AIzaSyB4zJ0nY_06VnOh-JEmpfhw8EzrvbCiIBA",
        authDomain: "texerp-ea015.firebaseapp.com",
        databaseURL: "https://texerp-ea015-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "texerp-ea015",
        storageBucket: "texerp-ea015.firebasestorage.app",
        messagingSenderId: "531851332664",
        appId: "1:531851332664:web:d2af3d69b6241d7fd8eacd"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const raporRef = db.ref("teknik_raporlar");

    let currentImgBase64 = "";

    function resimSec(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImgBase64 = e.target.result;
                document.getElementById('previewImg').src = currentImgBase64;
                document.getElementById('previewImg').classList.remove('hidden');
                document.getElementById('plusSign').classList.add('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function kaydet() {
        const id = document.getElementById('edit_id').value;
        const veri = {
            musteri: document.getElementById('musteri').value.toUpperCase(),
            kumas_cinsi: document.getElementById('kumas_cinsi').value.toUpperCase(),
            makine_bilgi: document.getElementById('makine_bilgi').value,
            gramaj: document.getElementById('gramaj').value,
            may_boyu: document.getElementById('may_boyu').value,
            tarih: document.getElementById('tarih').value,
            notlar: document.getElementById('notlar').value,
            img: currentImgBase64,
            ts: Date.now()
        };

        if(!veri.kumas_cinsi) return alert("Kuma≈ü cinsi zorunludur!");

        if(id) {
            raporRef.child(id).set(veri).then(() => { alert("G√ºncellendi!"); formTemizle(); });
        } else {
            raporRef.push(veri).then(() => { formTemizle(); });
        }
    }

    raporRef.on("value", (snap) => {
        const data = snap.val();
        listele(data);
    });

    function listele(data) {
        const body = document.getElementById('raporListesi');
        body.innerHTML = "";
        const aramaSorgu = document.getElementById('arama').value.toLowerCase();

        if(!data) return;

        const liste = Object.keys(data).map(k => ({id:k, ...data[k]}));
        liste.sort((a,b) => b.ts - a.ts);

        liste.forEach(r => {
            if(r.musteri.toLowerCase().includes(aramaSorgu) || r.kumas_cinsi.toLowerCase().includes(aramaSorgu)) {
                body.innerHTML += `
                    <tr class="border-b hover:bg-blue-50 transition">
                        <td class="p-2 text-center">
                            ${r.img ? `<img src="${r.img}" class="w-16 h-16 object-cover rounded shadow-sm mx-auto">` : `<div class="w-16 h-16 bg-gray-100 rounded mx-auto flex items-center justify-center text-xs text-gray-400">YOK</div>`}
                        </td>
                        <td class="p-3">
                            <div class="font-bold text-blue-900">${r.kumas_cinsi}</div>
                            <div class="text-xs text-gray-500">${r.musteri}</div>
                        </td>
                        <td class="p-3 text-center text-sm">${r.makine_bilgi} <br> <span class="font-bold">${r.gramaj} gr</span></td>
                        <td class="p-3 text-center text-sm">${r.may_boyu}</td>
                        <td class="p-3 text-center text-xs text-gray-600">${r.tarih}</td>
                        <td class="p-3 no-print text-center">
                            <button onclick="duzenle('${r.id}')" class="text-blue-600 font-bold mr-2">‚úèÔ∏è</button>
                            <button onclick="sil('${r.id}')" class="text-red-600 font-bold">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }
        });
    }

    function duzenle(id) {
        raporRef.child(id).once("value", (snap) => {
            const r = snap.val();
            document.getElementById('edit_id').value = id;
            document.getElementById('musteri').value = r.musteri;
            document.getElementById('kumas_cinsi').value = r.kumas_cinsi;
            document.getElementById('makine_bilgi').value = r.makine_bilgi;
            document.getElementById('gramaj').value = r.gramaj;
            document.getElementById('may_boyu').value = r.may_boyu;
            document.getElementById('tarih').value = r.tarih;
            document.getElementById('notlar').value = r.notlar;
            currentImgBase64 = r.img;
            
            if(r.img) {
                document.getElementById('previewImg').src = r.img;
                document.getElementById('previewImg').classList.remove('hidden');
                document.getElementById('plusSign').classList.add('hidden');
            }
            document.getElementById('anaButon').innerText = "DEƒûƒ∞≈ûƒ∞KLƒ∞KLERƒ∞ KAYDET";
            window.scrollTo({top: 0, behavior: 'smooth'});
        });
    }

    function sil(id) {
        if(confirm("Bu teknik raporu buluttan kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?")) {
            raporRef.child(id).remove();
        }
    }

    function formTemizle() {
        document.getElementById('edit_id').value = "";
        document.querySelectorAll('.input-alan').forEach(i => i.value = "");
        document.getElementById('previewImg').classList.add('hidden');
        document.getElementById('plusSign').classList.remove('hidden');
        currentImgBase64 = "";
        document.getElementById('anaButon').innerText = "BULUTA G√ñNDER / G√úNCELLE";
    }
</script>
</body>
</html>