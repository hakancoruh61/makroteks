<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAKROTEKS İğne Takip v3.7</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #1e293b; --success: #10b981; --danger: #ef4444; --blue: #3b82f6; --orange: #f59e0b; --purple: #8b5cf6; --gray: #64748b; }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; margin: 10px; background-color: #f8fafc; color: #1e293b; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .summary-card { padding: 15px; border-radius: 12px; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .suprem-card { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .kapak-card { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .silindir-card { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .genel-card { background: linear-gradient(135deg, #1e293b, #0f172a); }
        .summary-card div { font-size: 24px; font-weight: 800; margin-top: 4px; }

        .form-section { background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; align-items: end; }
        .input-group { display: flex; flex-direction: column; gap: 4px; }
        .input-group label { font-size: 11px; font-weight: 700; color: #475569; display: flex; justify-content: space-between; align-items: center; }
        
        select, input { padding: 8px 12px; border: 1.5px solid #cbd5e1; border-radius: 8px; font-size: 13px; outline: none; background: white; width: 100%; box-sizing: border-box; }

        .btn-save { background: var(--success); color: white; border: none; padding: 9px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; height: 38px; }
        
        .btn-new-link { color: var(--blue); cursor: pointer; font-size: 10px; text-decoration: underline; font-weight: 800; margin-left: 5px; }
        .btn-new-link:hover { opacity: 0.7; }

        .search-input { width: 100%; padding: 10px 15px; border-radius: 10px; border: 1.5px solid #e2e8f0; margin-bottom: 15px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
        th { background: #f8fafc; padding: 12px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        .stock-badge { background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 6px; font-weight: 800; }
    </style>
</head>
<body>

<div class="container">
    <div id="connStatus" style="float:right; font-size:11px; color:var(--success); font-weight:bold;">● SİSTEM ÇEVRİMİÇİ</div>
    <h2 style="font-size: 18px; margin-bottom: 20px;"><i class="fa-solid fa-microchip" style="color:var(--blue)"></i> MAKROTEKS İĞNE ENVANTERİ</h2>

    <div class="summary-grid">
        <div class="summary-card suprem-card"><h3>Süprem İğnesi</h3><div id="toplamSuprem">0</div></div>
        <div class="summary-card kapak-card"><h3>İnterlok Kapak</h3><div id="toplamKapak">0</div></div>
        <div class="summary-card silindir-card"><h3>İnterlok Silindir</h3><div id="toplamSilindir">0</div></div>
        <div class="summary-card genel-card"><h3>Genel Stok</h3><div id="toplamGenel">0</div></div>
    </div>

    <div class="form-section no-print">
        <div class="form-grid">
            <div class="input-group">
                <label>Örme Tipi</label>
                <select id="ormeTipi" onchange="igneTipleriniGuncelle()">
                    <option value="SÜPREM">SÜPREM</option>
                    <option value="İNTERLOK">İNTERLOK</option>
                </select>
            </div>
            <div class="input-group">
                <label>Bölüm</label>
                <select id="igneTipi"></select>
            </div>
            <div class="input-group">
                <label>Fain (E)</label>
                <input type="text" id="fain" placeholder="28E">
            </div>
            <div class="input-group">
                <label>Marka</label>
                <input type="text" id="marka" placeholder="Groz-B.">
            </div>
            <div class="input-group">
                <label>Ayak No</label>
                <input type="text" id="ayakNo" placeholder="1">
            </div>
            <div class="input-group">
                <label>
                    İğne No 
                    <span style="white-space: nowrap;">
                        <span class="btn-new-link" onclick="yeniIgneEkle()">+ Yeni</span>
                        <span class="btn-new-link" style="color:var(--orange)" onclick="igneNoDuzenle()">Dzn.</span>
                        <span class="btn-new-link" style="color:var(--danger)" onclick="igneNoSil()">Sil</span>
                    </span>
                </label>
                <select id="igneNoSelect"></select>
            </div>
            <div class="input-group">
                <label>Adet</label>
                <input type="number" id="adet" value="0">
            </div>
            <button class="btn-save" onclick="ekle()"><i class="fa-solid fa-floppy-disk"></i> KAYDET</button>
        </div>
    </div>

    <input type="text" id="fainSearch" class="search-input no-print" placeholder="Fain değerine göre filtrele..." onkeyup="tabloyuFiltrele()">

    <table>
        <thead>
            <tr>
                <th>Örme</th>
                <th>Bölüm</th>
                <th>Fain</th>
                <th>Marka</th>
                <th>Ayak</th>
                <th>İğne No</th>
                <th>Stok</th>
                <th class="no-print">+/- İşlem</th>
                <th class="no-print">Sil</th>
            </tr>
        </thead>
        <tbody id="igneBody"></tbody>
    </table>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB4zJ0nY_06VnOh-JEmpfhw8EzrvbCiIBA",
        authDomain: "texerp-ea015.firebaseapp.com",
        databaseURL: "https://texerp-ea015-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "texerp-ea015"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const igneRef = db.ref("igne_stoklari");
    let tumVeriler = {};

    function igneTipleriniGuncelle() {
        const orme = document.getElementById('ormeTipi').value;
        const igneSecim = document.getElementById('igneTipi');
        igneSecim.innerHTML = orme === "SÜPREM" 
            ? `<option value="SÜPREM İĞNESİ">SÜPREM İĞNESİ</option>` 
            : `<option value="KAPAK İĞNESİ">KAPAK İĞNESİ</option><option value="SİLİNDİR İĞNESİ">SİLİNDİR İĞNESİ</option>`;
    }

    function yeniIgneEkle() {
        const yeniNo = prompt("Lütfen yeni İğne Numarasını (VO) giriniz:");
        if (yeniNo) {
            const sel = document.getElementById('igneNoSelect');
            const opt = document.createElement('option');
            const val = yeniNo.toUpperCase().trim();
            opt.value = val;
            opt.text = val;
            opt.selected = true;
            sel.add(opt);
        }
    }

    function igneNoDuzenle() {
        const sel = document.getElementById('igneNoSelect');
        const eskiNo = sel.value;
        if (!eskiNo || eskiNo === "") return alert("Lütfen listeden geçerli bir iğne seçin!");

        const yeniNo = prompt("Seçili iğne numarasını TÜM kayıtlarda değiştir:", eskiNo);
        if (yeniNo && yeniNo.trim().toUpperCase() !== eskiNo) {
            const guncelNo = yeniNo.trim().toUpperCase();
            let guncellenenSayisi = 0;

            Object.keys(tumVeriler).forEach(key => {
                if (tumVeriler[key].no === eskiNo) {
                    igneRef.child(key).update({ no: guncelNo });
                    guncellenenSayisi++;
                }
            });
            alert(`${guncellenenSayisi} adet kayıt güncellendi.`);
        }
    }

    function igneNoSil() {
        const sel = document.getElementById('igneNoSelect');
        const no = sel.value;
        if (!no || no === "") return alert("Lütfen listeden silinecek bir iğne seçin!");

        if (confirm(`${no} numaralı iğneye ait TABLODAKİ TÜM STOK KAYITLARI SİLİNECEKTİR!\n\nEmin misiniz?`)) {
            let silinenSayisi = 0;
            Object.keys(tumVeriler).forEach(key => {
                if (tumVeriler[key].no === no) {
                    igneRef.child(key).remove();
                    silinenSayisi++;
                }
            });
            alert(`${silinenSayisi} adet kayıt başarıyla silindi.`);
        }
    }

    function ekle() {
        const veri = {
            orme: document.getElementById('ormeTipi').value,
            bolum: document.getElementById('igneTipi').value,
            fain: document.getElementById('fain').value.toUpperCase().trim(),
            marka: document.getElementById('marka').value.toUpperCase(),
            ayak: document.getElementById('ayakNo').value,
            no: document.getElementById('igneNoSelect').value,
            adet: parseInt(document.getElementById('adet').value) || 0
        };
        if(!veri.no || !veri.fain) return alert("Eksik bilgi! Lütfen Fain ve İğne No alanlarını doldurun.");
        igneRef.push(veri);
        document.getElementById('adet').value = 0;
    }

    igneRef.on("value", (snap) => {
        tumVeriler = snap.val() || {};
        const igneNoSelect = document.getElementById('igneNoSelect');
        const mevcutSecili = igneNoSelect.value;
        const noListesi = new Set();
        Object.values(tumVeriler).forEach(i => { if(i.no) noListesi.add(i.no); });
        
        igneNoSelect.innerHTML = '<option value="">Seçiniz...</option>';
        Array.from(noListesi).sort().forEach(no => {
            const opt = document.createElement('option');
            opt.value = no; opt.text = no;
            if(no === mevcutSecili) opt.selected = true;
            igneNoSelect.appendChild(opt);
        });
        tabloyuFiltrele();
    });

    function tabloyuFiltrele() {
        const body = document.getElementById('igneBody');
        const arama = document.getElementById('fainSearch').value.toUpperCase().trim();
        body.innerHTML = "";
        let sTop = 0, kTop = 0, siTop = 0;

        Object.keys(tumVeriler).forEach(key => {
            const i = tumVeriler[key];
            if(i.bolum === "SÜPREM İĞNESİ") sTop += i.adet;
            else if(i.bolum === "KAPAK İĞNESİ") kTop += i.adet;
            else if(i.bolum === "SİLİNDİR İĞNESİ") siTop += i.adet;

            if (arama === "" || i.fain.includes(arama)) {
                body.innerHTML += `
                    <tr>
                        <td><b>${i.orme}</b></td>
                        <td><small>${i.bolum}</small></td>
                        <td style="color:var(--blue); font-weight:bold">${i.fain}</td>
                        <td>${i.marka}</td>
                        <td>${i.ayak}</td>
                        <td>${i.no}</td>
                        <td><span class="stock-badge">${i.adet}</span></td>
                        <td class="no-print">
                            <input type="number" id="qty_${key}" value="50" style="width:45px">
                            <button onclick="stokGuncelle('${key}', 'artir')" style="background:var(--success); color:white; border:none; padding:2px 5px; border-radius:4px; cursor:pointer">+</button>
                            <button onclick="stokGuncelle('${key}', 'azalt')" style="background:var(--danger); color:white; border:none; padding:2px 5px; border-radius:4px; cursor:pointer">-</button>
                        </td>
                        <td class="no-print"><button onclick="sil('${key}')" style="border:none; background:none; cursor:pointer; color:var(--gray)"><i class="fa fa-trash"></i></button></td>
                    </tr>`;
            }
        });
        document.getElementById('toplamSuprem').innerText = sTop.toLocaleString();
        document.getElementById('toplamKapak').innerText = kTop.toLocaleString();
        document.getElementById('toplamSilindir').innerText = siTop.toLocaleString();
        document.getElementById('toplamGenel').innerText = (sTop + kTop + siTop).toLocaleString();
    }

    function stokGuncelle(id, tip) {
        const miktar = parseInt(document.getElementById('qty_' + id).value) || 0;
        let yeni = tip === 'artir' ? tumVeriler[id].adet + miktar : Math.max(0, tumVeriler[id].adet - miktar);
        igneRef.child(id).update({ adet: yeni });
    }

    function sil(id) { if(confirm("Bu satırı silmek istiyor musunuz?")) igneRef.child(id).remove(); }
    igneTipleriniGuncelle();
</script>
</body>
</html>