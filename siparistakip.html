<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAKROTEKS SipariÅŸ Takip v10.8</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --primary: #1a73e8; --success: #28a745; --danger: #dc3545; 
            --warning: #ffc107; --info: #17a2b8; --dark: #1e293b; --bg-soft: #f1f3f5;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #dfe4ea; margin: 20px; }
        .container { max-width: 1600px; margin: auto; background: var(--bg-soft); padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        #connStatus { padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; float: right; }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }

        .summary-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .summary-card { flex: 1; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); display: flex; flex-direction: column; }
        .summary-card.kalan { border-left-color: var(--danger); }
        .summary-label { font-size: 12px; color: #666; font-weight: bold; text-transform: uppercase; }
        .summary-value { font-size: 24px; font-weight: 800; color: var(--dark); margin-top: 5px; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ced4da; clear: both; }
        input, select, textarea { padding: 10px; border: 1px solid #adb5bd; border-radius: 6px; width: 100%; box-sizing: border-box; background: #ffffff; }
        
        button { padding: 8px 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.3s; display: inline-flex; align-items: center; gap: 5px; justify-content: center; font-size: 12px; }
        .btn-add { background: var(--success); color: white; font-size: 14px; }
        .btn-status-action { background: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb; }
        .btn-status-complete { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
        .btn-sevk { background: #673ab7; color: white; }
        .btn-edit { background: var(--warning); color: #333; }
        .btn-note { background: var(--info); color: white; }
        .btn-report { background: var(--dark); color: white; }
        .btn-del { background: var(--danger); color: white; }

        .filter-container { background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; border: 1px solid #ced4da; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; background: #ffffff; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px 12px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background: var(--dark); color: white; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
        .order-row { cursor: pointer; transition: background 0.2s; }
        .order-row:hover { background-color: #f8f9fa; }
        .action-panel { display: none; background: #fdfdfd; border-left: 5px solid var(--primary); }
        .action-content { padding: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

        .badge-kilo { padding: 6px 10px; border-radius: 4px; color: white; font-weight: normal; display: inline-block; min-width: 90px; text-align: center; }
        .siparis-kilo-ozel { background-color: var(--success); } 
        .sevk-kilo-ozel { background-color: var(--primary); }    
        .kalan-pozitif { background-color: var(--danger); }     
        .kalan-sifir { background-color: #6c757d; }              

        .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .beklemede { background: #fff3cd; color: #856404; }
        .Ã¼retiliyor { background: #cce5ff; color: #004085; }
        .bitti { background: #d4edda; color: #155724; }

        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.5); z-index: 1000; width: 450px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
        
        @media print { .no-print { display: none !important; } }
        .edit-calc-area { background: #f8f9fa; padding: 10px; border-radius: 8px; margin: 10px 0; border: 1px dashed #ccc; }
        .edit-calc-row { display: flex; gap: 5px; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div id="connStatus" class="offline">BAÄLANILIYOR...</div>
    <h2 style="text-align: center; color: var(--primary); margin-bottom: 25px;">ğŸ§µ MAKROTEKS SÄ°PARÄ°Å TAKÄ°P PANELÄ°</h2>

    <div class="summary-container no-print">
        <div class="summary-card">
            <span class="summary-label">Toplam SipariÅŸ MiktarÄ±</span>
            <span id="totalSiparis" class="summary-value">0.00 KG</span>
        </div>
        <div class="summary-card kalan">
            <span class="summary-label">Toplam Kalan SipariÅŸ</span>
            <span id="totalKalan" class="summary-value">0.00 KG</span>
        </div>
    </div>

    <div class="form-grid no-print">
        <input type="date" id="inpTarih">
        <input type="text" id="inpFirma" placeholder="Firma AdÄ±">
        <input type="text" id="inpKumas" placeholder="KumaÅŸ Cinsi">
        <input type="text" id="inpGramaj" placeholder="Gramaj">
        <input type="number" id="inpMiktar" placeholder="SipariÅŸ Toplam (KG)">
        <button class="btn-add" onclick="ekle()">â• SÄ°PARÄ°ÅÄ° KAYDET</button>
    </div>

    <div class="filter-container no-print">
        <label>ğŸ” LÄ°STELE:</label>
        <select id="filtre" onchange="listele()" style="width: 250px;">
            <option value="HEPSÄ°">TÃœM SÄ°PARÄ°ÅLER (Alfabetik)</option>
            <option value="ÃœRETÄ°LÄ°YOR" selected>âš™ï¸ ÃœRETÄ°MDEKÄ°LER</option>
            <option value="BEKLEMEDE">â³ BEKLEYENLER</option>
            <option value="BITTI">âœ… BÄ°TENLER</option>
        </select>
        <small style="color: #666; margin-left: auto;">* Ä°ÅŸlemleri gÃ¶rmek iÃ§in satÄ±ra tÄ±klayÄ±n.</small>
    </div>

    <table>
        <thead>
            <tr>
                <th>Tarih</th>
                <th>Firma</th>
                <th>KumaÅŸ</th>
                <th>Gramaj</th>
                <th>SipariÅŸ (KG)</th>
                <th>Sevk Edilen (KG)</th>
                <th>Kalan SipariÅŸ (KG)</th>
                <th>Durum</th>
            </tr>
        </thead>
        <tbody id="siparisTable"></tbody>
    </table>
</div>

<div class="modal-overlay" id="overlay" onclick="modalKapat()"></div>
<div class="modal" id="sevkModal">
    <h3>ğŸ“¦ Sevkiyat GiriÅŸi</h3>
    <p id="sevkBilgi" style="font-weight:bold; color:var(--primary);"></p>
    <p id="mevcutSevkBilgi" style="font-size:12px; color:#666; margin-bottom:15px;"></p>
    <label style="font-size:12px;">Yeni Sevk Edilen MiktarÄ± YazÄ±nÄ±z (KG):</label>
    <input type="number" id="sevkMiktarInput" style="margin-top:10px; border: 2px solid #673ab7; font-size: 18px;" placeholder="0.00" step="0.01">
    <button class="btn-sevk" onclick="sevkKaydet()" style="width:100%; margin-top:15px; padding:15px;">SEVKÄ°YATI EKLE VE TOPLA</button>
</div>

<div class="modal" id="editModal">
    <h3>âœï¸ Genel Bilgileri GÃ¼ncelle</h3>
    <label>Tarih</label><input type="text" id="editTarih" style="margin-bottom:8px;" placeholder="GG.AA.YYYY">
    <label>Firma</label><input type="text" id="editFirma" style="margin-bottom:8px;">
    <label>KumaÅŸ</label><input type="text" id="editKumas" style="margin-bottom:8px;">
    <label>Gramaj</label><input type="text" id="editGramaj" style="margin-bottom:8px;">
    <div class="edit-calc-area">
        <label>SipariÅŸ KG (Mevcut)</label>
        <input type="number" id="editMiktar" style="background: #e9ecef; font-weight: bold;">
        <div class="edit-calc-row">
            <input type="number" id="editMiktarIslem" placeholder="Eklenecek/DÃ¼ÅŸecek Miktar" step="0.01">
            <button class="btn-add" onclick="miktarHesapla('ekle')" style="background: var(--success);">â• EKLE</button>
            <button class="btn-add" onclick="miktarHesapla('dus')" style="background: var(--danger);">â– DÃœÅÃœR</button>
        </div>
    </div>
    <button class="btn-add" onclick="guncelle()" style="width:100%; margin-top:10px;">BÄ°LGÄ°LERÄ° KAYDET</button>
</div>

<div class="modal" id="notModal">
    <h3>ğŸ“‹ SipariÅŸ & Sevk NotlarÄ±</h3>
    <textarea id="notIcerik" style="height:150px; margin-bottom:15px;"></textarea>
    <button class="btn-add" onclick="notKaydet()" style="width:100%">NOTU KAYDET</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAeFLhVyrv4sn4kJmUtusLIOPWwgmKxe5c", 
        authDomain: "kumastakip-6930a.firebaseapp.com",
        databaseURL: "https://kumastakip-6930a-default-rtdb.firebaseio.com",
        projectId: "kumastakip-6930a",
        storageBucket: "kumastakip-6930a.firebasestorage.app",
        messagingSenderId: "796676836408",
        appId: "1:796676836408:web:cf74345b2a412cb1c26acd"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const sRef = db.ref('makroteks_siparisler'); 

    let tumSiparisler = [];
    let aktifID = null;

    window.onload = function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('inpTarih').value = today;
    };

    function fNum(num) {
        return (parseFloat(num) || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    db.ref(".info/connected").on("value", (snap) => {
        const el = document.getElementById('connStatus');
        if (snap.val() === true) { el.innerText = "â— BULUT AKTÄ°F"; el.className = "online"; }
        else { el.innerText = "â—‹ BAÄLANTI KESÄ°LDÄ°"; el.className = "offline"; }
    });

    sRef.on('value', (snapshot) => {
        const data = snapshot.val();
        tumSiparisler = [];
        if(data) {
            Object.keys(data).forEach(id => {
                let item = data[id];
                if(!item.durum) item.durum = "BEKLEMEDE"; 
                if(!item.sevk) item.sevk = 0;
                tumSiparisler.push({id, ...item});
            });
        }
        tumSiparisler.sort((a, b) => a.firma.localeCompare(b.firma, 'tr'));
        listele();
    });

    function listele() {
        const table = document.getElementById('siparisTable');
        const filtre = document.getElementById('filtre').value;
        table.innerHTML = "";

        let globalToplamSiparis = 0;
        let globalToplamKalan = 0;

        tumSiparisler.forEach(s => {
            const sipKG = parseFloat(s.miktar) || 0;
            const sevkKG = parseFloat(s.sevk) || 0;
            const kalanKG = sipKG - sevkKG;

            // Filtreleme kontrolÃ¼
            if(filtre !== "HEPSÄ°" && s.durum !== filtre) return;

            // ToplamlarÄ± hesapla (sadece filtreye uyanlarÄ± toplar)
            globalToplamSiparis += sipKG;
            globalToplamKalan += (kalanKG > 0 ? kalanKG : 0);

            const tr = document.createElement('tr');
            tr.className = "order-row";
            tr.onclick = () => toggleActions(s.id);
            tr.innerHTML = `
                <td><small style="color:#555; font-weight:bold;">${s.tarih || '-'}</small></td>
                <td><strong>${s.firma}</strong></td>
                <td>${s.kumas}</td>
                <td>${s.gramaj || '-'}</td>
                <td><span class="badge-kilo siparis-kilo-ozel">${fNum(sipKG)} KG</span></td>
                <td><span class="badge-kilo sevk-kilo-ozel">${fNum(sevkKG)} KG</span></td>
                <td><span class="badge-kilo ${kalanKG > 0 ? 'kalan-pozitif' : 'kalan-sifir'}">${fNum(kalanKG)} KG</span></td>
                <td><span class="status-badge ${s.durum.toLowerCase()}">${s.durum}</span></td>
            `;

            const actionTr = document.createElement('tr');
            actionTr.id = "actions-" + s.id;
            actionTr.className = "action-panel no-print";
            actionTr.innerHTML = `
                <td colspan="8">
                    <div class="action-content">
                        <span style="font-weight:bold; color:var(--dark); margin-right:10px;">Ä°ÅLEMLER:</span>
                        <button class="btn-status-action" onclick="durumDegistir('${s.id}', 'ÃœRETÄ°LÄ°YOR')">âš™ï¸ ÃœRETÄ°ME AL</button>
                        <button class="btn-status-complete" onclick="durumDegistir('${s.id}', 'BITTI')">âœ… BÄ°TTÄ° YAP</button>
                        <button class="btn-sevk" onclick="sevkAc('${s.id}')">ğŸ“¦ SEVKIYAT GÄ°R</button>
                        <button class="btn-edit" onclick="duzenleAc('${s.id}')">âœï¸ DÃœZENLE</button>
                        <button class="btn-note" onclick="notAc('${s.id}')">ğŸ“‹ NOTLAR</button>
                        <button class="btn-report" onclick="raporHazirla('${s.id}')">ğŸ–¨ï¸ YAZDIR</button>
                        <button class="btn-del" onclick="sil('${s.id}')">ğŸ—‘ï¸ SÄ°L</button>
                    </div>
                </td>
            `;
            table.appendChild(tr);
            table.appendChild(actionTr);
        });

        document.getElementById('totalSiparis').innerText = fNum(globalToplamSiparis) + " KG";
        document.getElementById('totalKalan').innerText = fNum(globalToplamKalan) + " KG";
    }

    function toggleActions(id) {
        const panel = document.getElementById("actions-" + id);
        const isVisible = panel.style.display === "table-row";
        document.querySelectorAll('.action-panel').forEach(p => p.style.display = "none");
        panel.style.display = isVisible ? "none" : "table-row";
    }

    function durumDegistir(id, yeniDurum) { sRef.child(id).update({ durum: yeniDurum }); }
    
    function ekle() {
        const t = document.getElementById('inpTarih').value;
        const f = document.getElementById('inpFirma').value;
        const k = document.getElementById('inpKumas').value;
        const m = document.getElementById('inpMiktar').value;
        if(!f || !k || !t) return alert("Eksik alan!");
        const p = t.split('-');
        const formatliTarih = p[2] + "." + p[1] + "." + p[0];
        sRef.push({
            tarih: formatliTarih, firma: f, kumas: k,
            gramaj: document.getElementById('inpGramaj').value,
            miktar: parseFloat(m) || 0,
            sevk: 0, durum: "BEKLEMEDE", not: ""
        });
        document.querySelectorAll('.form-grid input').forEach(i => { if(i.id !== 'inpTarih') i.value = ""; });
    }

    function sevkAc(id) {
        aktifID = id;
        const s = tumSiparisler.find(x => x.id === id);
        document.getElementById('sevkBilgi').innerText = s.firma + " - " + s.kumas;
        document.getElementById('mevcutSevkBilgi').innerText = "Toplam Sevk Edilen: " + fNum(s.sevk || 0) + " KG";
        document.getElementById('sevkMiktarInput').value = "";
        document.getElementById('sevkModal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        setTimeout(() => document.getElementById('sevkMiktarInput').focus(), 100);
    }

    function sevkKaydet() {
        const yeniGelen = parseFloat(document.getElementById('sevkMiktarInput').value) || 0;
        if(yeniGelen <= 0) return alert("Miktar giriniz.");
        const s = tumSiparisler.find(x => x.id === aktifID);
        sRef.child(aktifID).update({ sevk: (parseFloat(s.sevk) || 0) + yeniGelen });
        modalKapat();
    }

    function duzenleAc(id) {
        aktifID = id;
        const s = tumSiparisler.find(x => x.id === id);
        document.getElementById('editTarih').value = s.tarih || "";
        document.getElementById('editFirma').value = s.firma;
        document.getElementById('editKumas').value = s.kumas;
        document.getElementById('editGramaj').value = s.gramaj;
        document.getElementById('editMiktar').value = s.miktar;
        document.getElementById('editModal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function miktarHesapla(tip) {
        let mevcut = parseFloat(document.getElementById('editMiktar').value) || 0;
        let islem = parseFloat(document.getElementById('editMiktarIslem').value) || 0;
        document.getElementById('editMiktar').value = (tip === 'ekle' ? (mevcut + islem) : (mevcut - islem)).toFixed(2);
        document.getElementById('editMiktarIslem').value = ""; 
    }

    function guncelle() {
        sRef.child(aktifID).update({
            tarih: document.getElementById('editTarih').value,
            firma: document.getElementById('editFirma').value,
            kumas: document.getElementById('editKumas').value,
            gramaj: document.getElementById('editGramaj').value,
            miktar: parseFloat(document.getElementById('editMiktar').value) || 0
        });
        modalKapat();
    }

    function notAc(id) {
        aktifID = id;
        const s = tumSiparisler.find(x => x.id === id);
        document.getElementById('notIcerik').value = s.not || "";
        document.getElementById('notModal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function notKaydet() {
        sRef.child(aktifID).update({ not: document.getElementById('notIcerik').value });
        modalKapat();
    }

    function modalKapat() { document.querySelectorAll('.modal, .modal-overlay').forEach(m => m.style.display='none'); }
    function sil(id) { if(confirm("KaydÄ± silmek istiyor musunuz?")) sRef.child(id).remove(); }

    function raporHazirla(id) {
        const s = tumSiparisler.find(x => x.id === id);
        const rWindow = window.open('', '', 'width=900,height=850');
        rWindow.document.write(`<html><head><title>Talimat</title><style>body{font-family:sans-serif;padding:40px;}.h{border-bottom:5px solid #000;display:flex;justify-content:space-between;align-items:center;padding-bottom:10px;margin-bottom:30px;}.r{display:flex;border-bottom:1px solid #ccc;padding:15px 0;font-size:20px;}.l{width:250px;font-weight:bold;}.buyuk{font-size:28px;font-weight:900;margin-top:10px;}.n{margin-top:40px;padding:25px;border:2px solid #000;border-radius:10px;}</style></head><body><div class="h"><h1>MAKROTEKS KUMAÅÃ‡ILIK Ã–RME TALÄ°MATI</h1><span>${new Date().toLocaleDateString('tr-TR')}</span></div><div class="r"><div class="l">SipariÅŸ Tarihi:</div><div>${s.tarih || '-'}</div></div><div class="r"><div class="l">Firma:</div><div>${s.firma}</div></div><div class="r"><div class="l">KumaÅŸ Cinsi:</div><div>${s.kumas}</div></div><div class="r"><div class="l">Gramaj:</div><div>${s.gramaj || '-'}</div></div><div style="margin-top:30px;"><div style="font-size:20px;font-weight:bold;">TOPLAM SÄ°PARÄ°Å MÄ°KTARI:</div><div class="buyuk">${fNum(s.miktar)} KG</div></div><div class="n"><h3>NOTLAR</h3><p style="white-space:pre-wrap;font-size:18px;">${s.not || 'Yok'}</p></div><script>window.onload=function(){window.print();window.onafterprint=function(){window.close();};}<\/script></body></html>`);
        rWindow.document.close();
    }
</script>
</body>
</html>