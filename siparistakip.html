<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAKROTEKS Sipariş Yönetimi v20.0 - Full Paket</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --info: #0891b2; --warning: #d97706; --danger: #dc2626; --dark: #0f172a; --slate: #64748b; --purple: #7c3aed; }
        body { font-family: 'Inter', sans-serif; background: #f8fafc; margin: 15px; color: var(--dark); }
        .container { max-width: 100%; background: #fff; padding: 25px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        /* FORM VE PANEL */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 25px; background: #f1f5f9; padding: 20px; border-radius: 12px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: 700; font-size: 11px; color: var(--slate); text-transform: uppercase; }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; font-size: 14px; }
        
        /* ÜST TOPLAM PANELİ */
        .summary-panel { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .summary-card { background: var(--dark); color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .summary-card span { display: block; font-size: 11px; font-weight: 700; color: #94a3b8; margin-bottom: 5px; text-transform: uppercase; }
        .summary-card b { font-size: 24px; color: #38bdf8; }
        .summary-card.sevk { background: #065f46; } .summary-card.sevk b { color: #4ade80; }
        .summary-card.kalan { background: #991b1b; } .summary-card.kalan b { color: #fca5a5; }

        /* FİLTRELER */
        .filter-section { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; background: white; }
        .filter-btn.active { background: var(--dark); color: white; border-color: var(--dark); }
        .company-filter-box { display: flex; align-items: center; gap: 10px; background: #fff; padding: 5px 15px; border-radius: 8px; border: 1px solid #e2e8f0; }

        /* TABLO */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
        th { background: #f8fafc; color: var(--slate); padding: 15px; text-align: left; font-size: 12px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .box { padding: 5px 10px; border-radius: 6px; color: white; font-weight: 700; font-size: 13px; display: inline-block; min-width: 80px; text-align: center; }

        /* İŞLEMLER PANELİ */
        .action-container { display: none; background: #fff; border: 2px solid #2563eb; border-radius: 12px; padding: 15px; margin: 10px 0; animation: fadeIn 0.3s; }
        .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .action-buttons button { border: 1px solid #cbd5e1; background: #fff; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .action-buttons button:hover { background: #f8fafc; border-color: var(--primary); }

        /* YAZDIRMA (A4) */
        @page { size: A4; margin: 10mm; }
        @media print {
            .no-print { display: none !important; }
            #printArea { display: block !important; visibility: visible !important; width: 100%; }
            body * { visibility: hidden; }
            #printArea * { visibility: visible; }
        }
        #printArea { display: none; color: black; }
        .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .print-table td { border: 2px solid black; padding: 12px; font-size: 18px; }
        .p-label { background: #eee; font-weight: bold; width: 30%; }
        .p-big { font-size: 22pt !important; font-weight: 900 !important; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="printArea">
    <div style="text-align: center; border-bottom: 4px double black; padding-bottom: 10px;">
        <h1 style="margin:0;">MAKROTEKS KUMAŞÇILIK</h1>
        <h2 style="margin:5px 0;">ÖRME TALİMATI</h2>
    </div>
    <table class="print-table">
        <tr><td class="p-label">SİPARİŞ TARİHİ</td><td id="p_tarih"></td></tr>
        <tr><td class="p-label">FİRMA ADI</td><td id="p_firma"></td></tr>
        <tr><td class="p-label">KUMAŞ İSMİ</td><td id="p_kumas" class="p-big"></td></tr>
        <tr><td class="p-label">KUMAŞ GRAMAJI</td><td id="p_gramaj" class="p-big"></td></tr>
        <tr><td class="p-label">SİPARİŞ MİKTARI</td><td id="p_miktar" style="font-size: 24px; font-weight: bold;"></td></tr>
    </table>
    <h3 style="margin-top:20px;">NOTLAR / TALİMATLAR:</h3>
    <div id="p_notlar" style="border: 2px solid black; padding: 15px; min-height: 200px; font-size: 16px;"></div>
</div>

<div class="container no-print">
    <h2><i class="fa-solid fa-industry" style="color:var(--primary)"></i> MAKROTEKS SİPARİŞ TAKİP</h2>

    <div class="form-grid">
        <input type="hidden" id="edit_id">
        <div class="input-group"><label>Tarih</label><input type="date" id="s_tarih"></div>
        <div class="input-group"><label>Firma</label><input type="text" id="s_firma" placeholder="Müşteri"></div>
        <div class="input-group"><label>Kumaş</label><input type="text" id="s_kumas" placeholder="Kumaş Cinsi"></div>
        <div class="input-group"><label>Gramaj</label><input type="text" id="s_gramaj" placeholder="Örn: 160gr"></div>
        <div class="input-group"><label>Miktar (KG)</label><input type="number" id="s_miktar" placeholder="0.00"></div>
        <div class="input-group" style="justify-content: flex-end;">
            <button onclick="kaydet()" id="saveBtn" style="background:var(--primary); color:white; padding:10px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; height:42px;"><i class="fa-solid fa-plus"></i> KAYDET</button>
        </div>
    </div>

    <div class="summary-panel">
        <div class="summary-card"><span>TOPLAM SİPARİŞ</span><b id="toplamSiparisKG">0 KG</b></div>
        <div class="summary-card sevk"><span>TOPLAM SEVK</span><b id="toplamSevkKG">0 KG</b></div>
        <div class="summary-card kalan"><span>TOPLAM KALAN</span><b id="toplamKalanKG">0 KG</b></div>
    </div>

    <div class="filter-section">
        <button class="filter-btn active" id="btn-Üretimde" onclick="filtrele('Üretimde')">ÜRETİMDE</button>
        <button class="filter-btn" id="btn-Beklemede" onclick="filtrele('Beklemede')">BEKLEMEDE</button>
        <button class="filter-btn" id="btn-Bitti" onclick="filtrele('Bitti')">BİTTİ</button>
        <button class="filter-btn" id="btn-Tümü" onclick="filtrele('Tümü')">TÜMÜ</button>
        
        <div class="company-filter-box" style="margin-left: auto;">
            <label style="margin:0; font-size:10px;">KUMAŞ ARA:</label>
            <input type="text" id="filter_kumas" oninput="filtrele(aktifFiltre)" placeholder="Kumaş adı..." style="padding: 5px; font-size: 12px; border: 1px solid #e2e8f0; border-radius: 4px;">
        </div>

        <div class="company-filter-box">
            <label style="margin:0; font-size:10px;">FİRMA SEÇİN:</label>
            <select id="filter_firma" onchange="filtrele(aktifFiltre)" style="padding: 5px; font-size: 12px;">
                <option value="Tümü">Tüm Firmalar</option>
            </select>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>TARİH</th>
                <th>FİRMA</th>
                <th>KUMAŞ / GR</th>
                <th>SİPARİŞ</th>
                <th>SEVK</th>
                <th>KALAN</th>
                <th>DURUM</th>
            </tr>
        </thead>
        <tbody id="siparisListesi"></tbody>
    </table>
</div>

<div id="modalOverlay" onclick="modalKapat()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:999;"></div>
<div id="notModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:25px; border-radius:15px; z-index:1000; width:450px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
    <h3 style="margin-top:0;"><i class="fa-solid fa-comment-dots"></i> Sipariş Notları</h3>
    <input type="hidden" id="not_edit_id">
    <textarea id="modal_not_text" style="width:100%; height:150px; padding:10px; border:1px solid #ccc; border-radius:8px; font-family:inherit; resize:none;"></textarea>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
        <button onclick="modalKapat()" style="padding:10px 20px; border:none; background:#f1f5f9; border-radius:8px; cursor:pointer;">Kapat</button>
        <button onclick="notlariKaydet()" style="padding:10px 20px; border:none; background:var(--success); color:white; border-radius:8px; font-weight:bold; cursor:pointer;">KAYDET</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB4zJ0nY_06VnOh-JEmpfhw8EzrvbCiIBA",
        authDomain: "texerp-ea015.firebaseapp.com",
        databaseURL: "https://texerp-ea015-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "texerp-ea015"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ref = db.ref("siparis_yonetimi");

    let tumVeriler = {};
    let aktifFiltre = "Üretimde";

    function fmt(n) { return new Intl.NumberFormat('tr-TR', { maximumFractionDigits: 2 }).format(n); }
    function fmtTarih(t) { if(!t) return "-"; const p = t.split("-"); return `${p[2]}.${p[1]}.${p[0]}`; }

    function kaydet() {
        const id = document.getElementById('edit_id').value;
        const veri = {
            tarih: document.getElementById('s_tarih').value,
            firma: document.getElementById('s_firma').value.toUpperCase().trim(),
            kumas: document.getElementById('s_kumas').value.toUpperCase(),
            gramaj: document.getElementById('s_gramaj').value,
            miktar: parseFloat(document.getElementById('s_miktar').value) || 0,
            timestamp: Date.now()
        };
        if(!veri.firma || veri.miktar <= 0) return alert("Hata: Firma ve Miktar girmelisiniz!");
        
        if(id) {
            ref.child(id).update(veri).then(() => formuTemizle());
        } else {
            veri.sevkedilen = 0;
            veri.durum = "Üretimde";
            veri.notlar = "";
            ref.push(veri).then(() => formuTemizle());
        }
    }

    ref.on("value", snap => {
        tumVeriler = snap.val() || {};
        const list = document.getElementById('siparisListesi');
        const firmaFiltreSelect = document.getElementById('filter_firma');
        const seciliFirma = firmaFiltreSelect.value;
        const arananKumas = document.getElementById('filter_kumas').value.toUpperCase();
        
        list.innerHTML = "";
        
        const firmalar = new Set();
        Object.values(tumVeriler).forEach(v => { if(v.firma) firmalar.add(v.firma); });
        
        firmaFiltreSelect.innerHTML = '<option value="Tümü">Tüm Firmalar</option>';
        Array.from(firmalar).sort().forEach(f => {
            const opt = document.createElement('option');
            opt.value = f;
            opt.innerText = f;
            if(f === seciliFirma) opt.selected = true;
            firmaFiltreSelect.appendChild(opt);
        });

        let tSiparis = 0, tSevk = 0, tKalan = 0;
        
        const keys = Object.keys(tumVeriler)
            .filter(k => k !== 'trigger')
            .sort((a,b) => {
                const dateA = new Date(tumVeriler[a].tarih || 0);
                const dateB = new Date(tumVeriler[b].tarih || 0);
                return dateB - dateA; 
            });

        keys.forEach(key => {
            const s = tumVeriler[key];
            
            if(aktifFiltre !== "Tümü" && s.durum !== aktifFiltre) return;
            if(seciliFirma !== "Tümü" && s.firma !== seciliFirma) return;
            if(arananKumas && !s.kumas.toUpperCase().includes(arananKumas)) return;

            const sevk = s.sevkedilen || 0;
            const kalan = s.miktar - sevk;
            tSiparis += s.miktar; tSevk += sevk; tKalan += kalan;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td onclick="menuAc('${key}')" style="cursor:pointer; color:var(--slate)">${fmtTarih(s.tarih)}</td>
                <td onclick="menuAc('${key}')" style="font-weight:700; cursor:pointer">${s.firma}</td>
                <td onclick="menuAc('${key}')" style="cursor:pointer">${s.kumas} <small>(${s.gramaj})</small></td>
                <td><span class="box" style="background:var(--success)">${fmt(s.miktar)}</span></td>
                <td><span class="box" style="background:var(--info)">${fmt(sevk)}</span></td>
                <td><span class="box" style="background:var(--danger)">${fmt(kalan)}</span></td>
                <td style="font-weight:800; font-size:11px;">${s.durum.toUpperCase()}</td>
            `;
            
            const actionRow = document.createElement('tr');
            actionRow.className = "no-print";
            actionRow.innerHTML = `
                <td colspan="7" style="padding:0; border:none">
                    <div id="menu-${key}" class="action-container">
                        <div class="action-buttons">
                            <button onclick="talimatYazdir('${key}')" style="background:var(--dark); color:white;"><i class="fa fa-print"></i> ÖRME TALİMATI YAZDIR</button>
                            <button onclick="notModaliAc('${key}')"><i class="fa-solid fa-message"></i> NOTLAR</button>
                            <button onclick="sevkiyatGir('${key}')"><i class="fa-solid fa-truck-loading"></i> SEVKİYAT GİR</button>
                            <button onclick="kgGuncelle('${key}')" style="color:var(--purple); border-color:var(--purple);"><i class="fa-solid fa-plus-minus"></i> SİPARİŞ KG +/-</button>
                            <button onclick="durumGuncelle('${key}','Üretimde')"><i class="fa fa-play"></i> ÜRETİMDE</button>
                            <button onclick="durumGuncelle('${key}','Beklemede')"><i class="fa fa-pause"></i> BEKLETMEYE AL</button>
                            <button onclick="durumGuncelle('${key}','Bitti')"><i class="fa fa-check-double"></i> BİTTİ</button>
                            <button onclick="duzenle('${key}')"><i class="fa fa-edit"></i> DÜZENLE</button>
                            <button onclick="sil('${key}')" style="color:var(--danger)"><i class="fa fa-trash"></i> SİL</button>
                        </div>
                    </div>
                </td>
            `;
            list.appendChild(tr);
            list.appendChild(actionRow);
        });

        document.getElementById('toplamSiparisKG').innerText = fmt(tSiparis) + " KG";
        document.getElementById('toplamSevkKG').innerText = fmt(tSevk) + " KG";
        document.getElementById('toplamKalanKG').innerText = fmt(tKalan) + " KG";
    });

    function menuAc(id) {
        const m = document.getElementById(`menu-${id}`);
        const v = m.style.display === 'block';
        document.querySelectorAll('.action-container').forEach(el => el.style.display = 'none');
        if(!v) m.style.display = 'block';
    }

    function kgGuncelle(id) {
        const fark = prompt("Mevcut sipariş miktarına EKLEMEK için Örn: 100, DÜŞÜRMEK için Örn: -100 yazın:");
        if(fark && !isNaN(fark)) {
            const yeni = (tumVeriler[id].miktar || 0) + parseFloat(fark);
            if(yeni < 0) return alert("Miktar 0'ın altına düşemez!");
            ref.child(id).update({ miktar: yeni });
        }
    }

    function sevkiyatGir(id) {
        const sevk = prompt("Yapılan sevkiyat miktarını (KG) girin:");
        if(sevk && !isNaN(sevk)) {
            const yeniSevk = (tumVeriler[id].sevkedilen || 0) + parseFloat(sevk);
            ref.child(id).update({ sevkedilen: yeniSevk });
        }
    }

    function talimatYazdir(id) {
        const s = tumVeriler[id];
        document.getElementById('p_tarih').innerText = fmtTarih(s.tarih);
        document.getElementById('p_firma').innerText = s.firma;
        document.getElementById('p_kumas').innerText = s.kumas;
        document.getElementById('p_gramaj').innerText = s.gramaj;
        document.getElementById('p_miktar').innerText = fmt(s.miktar) + " KG";
        document.getElementById('p_notlar').innerText = s.notlar || "Özel bir not girilmemiştir.";
        window.print();
    }

    function notModaliAc(id) {
        document.getElementById('not_edit_id').value = id;
        document.getElementById('modal_not_text').value = tumVeriler[id].notlar || "";
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('notModal').style.display = 'block';
    }

    function notlariKaydet() {
        ref.child(document.getElementById('not_edit_id').value).update({ 
            notlar: document.getElementById('modal_not_text').value 
        }).then(() => modalKapat());
    }

    function modalKapat() { 
        document.getElementById('modalOverlay').style.display = 'none'; 
        document.getElementById('notModal').style.display = 'none'; 
    }

    function duzenle(id) {
        const s = tumVeriler[id];
        document.getElementById('edit_id').value = id;
        document.getElementById('s_tarih').value = s.tarih;
        document.getElementById('s_firma').value = s.firma;
        document.getElementById('s_kumas').value = s.kumas;
        document.getElementById('s_gramaj').value = s.gramaj;
        document.getElementById('s_miktar').value = s.miktar;
        document.getElementById('saveBtn').innerHTML = "<i class='fa-solid fa-sync'></i> GÜNCELLE";
        window.scrollTo(0,0);
    }

    function filtrele(f) {
        aktifFiltre = f;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + f).classList.add('active');
        ref.child('trigger').set(Date.now());
    }

    function durumGuncelle(id, d) { ref.child(id).update({ durum: d }); }
    function sil(id) { if(confirm("Bu siparişi silmek istediğinize emin misiniz?")) ref.child(id).remove(); }
    
    function formuTemizle() { 
        document.getElementById('edit_id').value = ""; 
        document.querySelectorAll('.form-grid input').forEach(i => { if(i.type !== 'date') i.value = ""; });
        document.getElementById('saveBtn').innerHTML = "<i class='fa-solid fa-plus'></i> KAYDET";
        document.getElementById('s_tarih').valueAsDate = new Date();
    }

    document.getElementById('s_tarih').valueAsDate = new Date();
</script>
</body>
</html>