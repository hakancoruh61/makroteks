<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAKROTEKS Maliyet v21.0 - Tam Detay Yükleme</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #0f172a; --accent: #0ea5e9; --success: #10b981; --danger: #ef4444; --slate: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: #f8fafc; padding: 20px; color: #1e293b; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .exchange-bar { background: var(--primary); color: white; padding: 12px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .results-container-top { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .cost-card { padding: 20px; border-radius: 16px; text-align: center; border: 2px solid #e2e8f0; }
        .usd-val { font-size: 34px; font-weight: 900; margin: 5px 0; display: block; }
        .section { background: var(--slate); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 11px; font-weight: 700; color: #64748b; }
        input { padding: 10px; border: 1.5px solid #cbd5e1; border-radius: 8px; font-weight: 600; }
        .iplik-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .button-group { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn { padding: 15px; border-radius: 12px; font-weight: 800; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-calc { background: var(--primary); color: white; }
        .btn-save { background: var(--success); color: white; }
        .btn-print { background: #6366f1; color: white; }
        .btn-clear { background: #94a3b8; color: white; }
        .row-link { cursor: pointer; transition: 0.2s; }
        .row-link:hover { background: #f1f5f9; }
        #saveMsg { color: var(--success); font-weight: bold; text-align: center; margin-bottom: 10px; display: none; }
        @media print { .button-group, .history-section, .btn-clear, i, button { display: none !important; } }
    </style>
</head>
<body>

<div class="container">
    <div class="exchange-bar">
        <span><i class="fa-solid fa-building-columns"></i> MAKROTEKS MALİYET</span>
        <span>USD Kuru: <b id="usdTry">--.--</b> TL</span>
    </div>

    <div id="saveMsg">✅ Buluta Kaydedildi ve Listeye Eklendi!</div>
    
    <div class="results-container-top">
        <div class="cost-card">
            <h2 style="font-size: 11px; color: #64748b; margin:0">HAM MALİYET</h2>
            <span class="usd-val" id="hamUsd">0.00 $</span>
            <span id="hamTl" style="color:#64748b">0.00 TL</span>
        </div>
        <div class="cost-card" style="border-color: var(--success); background: #f0fdf4;">
            <h2 style="font-size: 11px; color: var(--success); margin:0">BOYALI MALİYET</h2>
            <span class="usd-val" id="boyaliUsd" style="color:var(--success)">0.00 $</span>
            <span id="boyaliTl" style="color:#64748b">0.00 TL</span>
        </div>
    </div>

    <div class="grid-3" style="margin-bottom: 20px;">
        <div class="input-group"><label>Kumaş Adı / Kalite</label><input type="text" id="kumasAdi" placeholder="Kumaş ismi..."></div>
        <div class="input-group"><label>Manuel Kur Müdahale</label><input type="number" id="manuelKur" step="0.01"></div>
    </div>

    <div class="section">
        <div class="section-title" style="font-weight: 800; font-size: 12px; margin-bottom: 10px;">İPLİK KARIŞIMI</div>
        <div id="iplikListesi"></div>
        <button onclick="iplikSatirEkle()" style="border:none; background:none; color:var(--accent); cursor:pointer; font-weight:bold; margin-top:10px">+ Yeni İplik Ekle</button>
    </div>

    <div class="grid-3">
        <div class="section">
            <div class="input-group"><label>Örgü Ücreti ($)</label><input type="number" id="orgu" value="0.50" step="0.01"></div>
            <div class="input-group" style="margin-top:10px"><label>Ham Fire (%)</label><input type="number" id="hamFire" value="3"></div>
        </div>
        <div class="section">
            <div class="input-group"><label>Boya Ücreti ($)</label><input type="number" id="boya" value="1.20" step="0.01"></div>
            <div class="input-group" style="margin-top:10px"><label>Boya Fire (%)</label><input type="number" id="boyaFire" value="5"></div>
        </div>
        <div class="section">
            <div class="input-group"><label>Genel Gider ($)</label><input type="number" id="genelGider" value="0.20" step="0.01"></div>
        </div>
    </div>

    <div class="button-group">
        <button class="btn btn-calc" onclick="hesapla()"><i class="fa-solid fa-calculator"></i> HESAPLA</button>
        <button class="btn btn-save" onclick="kaydet()"><i class="fa-solid fa-cloud-arrow-up"></i> KAYDET</button>
        <button class="btn btn-print" onclick="window.print()"><i class="fa-solid fa-print"></i> YAZDIR</button>
        <button class="btn btn-clear" onclick="temizle()"><i class="fa-solid fa-trash-can"></i> TEMİZLE</button>
    </div>

    <div class="history-section" style="margin-top:30px; border-top:1px solid #ddd; padding-top:20px;">
        <h3 style="font-size:14px;">GEÇMİŞ KAYITLAR (Detay için satıra tıklayın)</h3>
        <table style="width:100%; text-align:left; border-collapse:collapse;">
            <thead>
                <tr style="background:#f1f5f9">
                    <th style="padding:10px">Tarih</th>
                    <th>Kumaş</th>
                    <th>Boyalı $</th>
                    <th>Sil</th>
                </tr>
            </thead>
            <tbody id="gecmisBody"></tbody>
        </table>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB4zJ0nY_06VnOh-JEmpfhw8EzrvbCiIBA",
        authDomain: "texerp-ea015.firebaseapp.com",
        databaseURL: "https://texerp-ea015-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "texerp-ea015"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const maliyetRef = db.ref("maliyet_kayitlari");

    async function kurGetir() {
        try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
            const data = await res.json();
            document.getElementById('usdTry').innerText = data.rates.TRY.toFixed(4);
        } catch (e) { document.getElementById('usdTry').innerText = "34.50"; }
    }

    function iplikSatirEkle(ad='', oran='', fiyat='') {
        const div = document.createElement('div');
        div.className = 'iplik-row';
        div.innerHTML = `
            <input type="text" class="i-ad" placeholder="İplik Cinsi" style="flex:2" value="${ad}">
            <input type="number" class="i-fiyat" placeholder="Fiyat $" style="flex:1" value="${fiyat}" step="0.01">
            <input type="number" class="i-oran" placeholder="Oran %" style="flex:1" value="${oran}">
            <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer"><i class="fa fa-times"></i></button>
        `;
        document.getElementById('iplikListesi').appendChild(div);
    }

    function hesapla() {
        let kur = parseFloat(document.getElementById('manuelKur').value) || parseFloat(document.getElementById('usdTry').innerText);
        let iplikTop = 0;
        document.querySelectorAll('.iplik-row').forEach(row => {
            const f = parseFloat(row.querySelector('.i-fiyat').value) || 0;
            const o = parseFloat(row.querySelector('.i-oran').value) || 0;
            iplikTop += (f * o) / 100;
        });

        const orgu = parseFloat(document.getElementById('orgu').value) || 0;
        const hF = parseFloat(document.getElementById('hamFire').value) || 0;
        const boya = parseFloat(document.getElementById('boya').value) || 0;
        const bF = parseFloat(document.getElementById('boyaFire').value) || 0;
        const gG = parseFloat(document.getElementById('genelGider').value) || 0;

        const ham = (iplikTop / (1 - (hF/100))) + orgu;
        const boyali = (ham / (1 - (bF/100))) + boya + gG;

        document.getElementById('hamUsd').innerText = ham.toFixed(2) + " $";
        document.getElementById('hamTl').innerText = (ham * kur).toFixed(2) + " TL";
        document.getElementById('boyaliUsd').innerText = boyali.toFixed(2) + " $";
        document.getElementById('boyaliTl').innerText = (boyali * kur).toFixed(2) + " TL";
        
        return { ham, boyali, kur, orgu, hF, boya, bF, gG };
    }

    function kaydet() {
        const d = hesapla();
        const kumas = document.getElementById('kumasAdi').value.trim();
        if(!kumas) return alert("Kumaş Adı giriniz!");

        const iplikler = [];
        document.querySelectorAll('.iplik-row').forEach(row => {
            iplikler.push({
                ad: row.querySelector('.i-ad').value,
                fiyat: row.querySelector('.i-fiyat').value,
                oran: row.querySelector('.i-oran').value
            });
        });

        maliyetRef.push({
            kumas: kumas.toUpperCase(),
            tarih: new Date().toLocaleString('tr-TR'),
            kur: d.kur,
            orgu: d.orgu, hFire: d.hF, boya: d.boya, bFire: d.bF, gGider: d.gG,
            iplikler: iplikler,
            boyaliUsd: d.boyali.toFixed(2),
            timestamp: Date.now()
        }).then(() => {
            document.getElementById('saveMsg').style.display = "block";
            setTimeout(() => document.getElementById('saveMsg').style.display = "none", 2000);
        });
    }

    // KAYITLI KUMAŞA TIKLAYINCA DETAYLARI DOLDURAN FONKSİYON
    function yukle(id) {
        maliyetRef.child(id).once("value", (snap) => {
            const m = snap.val();
            if(!m) return;

            // Form alanlarını doldur
            document.getElementById('kumasAdi').value = m.kumas;
            document.getElementById('manuelKur').value = m.kur;
            document.getElementById('orgu').value = m.orgu;
            document.getElementById('hamFire').value = m.hFire;
            document.getElementById('boya').value = m.boya;
            document.getElementById('boyaFire').value = m.bFire;
            document.getElementById('genelGider').value = m.gGider;

            // İplik listesini temizle ve yeniden oluştur
            const liste = document.getElementById('iplikListesi');
            liste.innerHTML = "";
            if(m.iplikler) {
                m.iplikler.forEach(i => iplikSatirEkle(i.ad, i.oran, i.fiyat));
            }

            hesapla(); // Veriler dolunca otomatik hesapla
            window.scrollTo({top: 0, behavior: 'smooth'});
        });
    }

    maliyetRef.on("value", (snap) => {
        const body = document.getElementById('gecmisBody');
        body.innerHTML = "";
        const veriler = snap.val();
        if(!veriler) return;
        const sirali = Object.keys(veriler).map(id => ({id, ...veriler[id]})).sort((a,b) => b.timestamp - a.timestamp);
        sirali.forEach(m => {
            body.innerHTML += `
            <tr class="row-link" style="border-bottom:1px solid #eee">
                <td style="padding:10px" onclick="yukle('${m.id}')">${m.tarih}</td>
                <td onclick="yukle('${m.id}')"><b>${m.kumas}</b></td>
                <td onclick="yukle('${m.id}')" style="color:green; font-weight:bold">${m.boyaliUsd} $</td>
                <td><i class="fa fa-trash" style="color:red; cursor:pointer" onclick="maliyetRef.child('${m.id}').remove()"></i></td>
            </tr>`;
        });
    });

    function temizle() { if(confirm("Tüm ekran sıfırlansın mı?")) location.reload(); }

    kurGetir();
    iplikSatirEkle("Pamuk", 100, 4.50);
</script>
</body>
</html>