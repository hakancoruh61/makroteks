<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAKROTEKS | Puantaj Sistemi v9.2</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #1e293b;
            --success-blue: #000080; 
            --danger-bg: #cc0000;   
            --bg: #f8fafc;
            --table-border: #000000;
        }

        body { 
            font-family: 'Inter', system-ui, sans-serif; 
            background-color: var(--bg); 
            margin: 0; padding: 10px; color: var(--primary);
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }

        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 2px solid var(--primary); padding-bottom: 10px;
        }

        .report-title { text-transform: uppercase; font-weight: 800; font-size: 18px; margin: 0; }

        .toolbar {
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;
            padding: 12px; background: #f1f5f9; border-radius: 6px; align-items: flex-end;
        }

        .input-group { display: flex; flex-direction: column; gap: 4px; }
        .input-group label { font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; }

        input, select, textarea { padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px; }

        button { padding: 8px 12px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; }
        .btn-main { background: var(--primary); color: white; }
        .btn-success { background: #10b981; color: white; }

        .table-wrapper { width: 100%; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
        th, td { border: 1px solid var(--table-border); text-align: center; height: 22px; }
        th { background: #f1f5f9; font-size: 9px; }

        .name-col { text-align: left; padding-left: 5px; width: 140px; overflow: hidden; white-space: nowrap; }
        .day-cell { width: 20px; cursor: pointer; font-weight: 900; font-size: 12px; }
        
        .present { color: var(--success-blue) !important; background-color: #f0f9ff; }
        .absent { background-color: var(--danger-bg) !important; color: #ffffff !important; }

        .summary-col { font-weight: 700; background: #f8fafc; width: 30px; }
        .money-col { font-weight: 700; width: 70px; }

        /* NOTLAR B√ñL√úM√ú - 10 SATIR G√ñR√úN√úM√ú */
        .notes-box { 
            margin-top: 15px; 
            border: 1px solid var(--table-border); 
            border-radius: 4px; 
            width: 100%;
        }
        .notes-box h3 { 
            margin: 0; 
            font-size: 11px; 
            background: #f1f5f9; 
            padding: 5px 10px; 
            border-bottom: 1px solid var(--table-border);
        }
        
        #aylikNot { 
            width: 100%; 
            border: none; 
            background: transparent; 
            font-size: 13px; 
            line-height: 1.5em; /* Satƒ±r y√ºksekliƒüi */
            padding: 10px;
            /* Varsayƒ±lan olarak 10 satƒ±r y√ºksekliƒüi (10 * 1.5em = 15em) */
            min-height: 15em; 
            resize: none; 
            box-sizing: border-box;
            display: block;
            overflow: hidden;
            white-space: pre-wrap;
        }

        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            .no-print { display: none !important; }
            .container { width: 100%; max-width: 100%; padding: 0; border: none; }
            body { background: white; padding: 0; }
            .notes-box { border: 1px solid #000; break-inside: avoid; }
            #aylikNot { 
                height: auto !important; 
                min-height: 15em; /* √áƒ±ktƒ±da da en az 10 satƒ±rlƒ±k yer kaplar */
                background-image: linear-gradient(#eee 1px, transparent 1px);
                background-size: 100% 1.5em;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div><h1 id="dynamicTitle" class="report-title">MAKROTEKS PUANTAJ RAPORU</h1></div>
        <button class="btn-main no-print" onclick="window.print()">üñ®Ô∏è PDF / YAZDIR</button>
    </header>

    <div class="toolbar no-print">
        <div class="input-group">
            <label>D√∂nem</label>
            <select id="aySecici" onchange="listele()"></select>
        </div>
        <div class="input-group">
            <label>Personel Ekle</label>
            <input type="text" id="p_ad" placeholder="AD SOYAD">
        </div>
        <button class="btn-success" onclick="pEkle()">Ekle</button>
        <div style="flex-grow: 1;"></div>
        <div class="input-group">
            <label>Birim Fiyat (‚Ç∫)</label>
            <input type="number" id="birimFiyat" step="0.01" style="width:70px;" onchange="fiyatKaydet(this.value)">
        </div>
    </div>

    <div class="table-wrapper">
        <table>
            <thead><tr id="gunlerRow"><th class="name-col">PERSONEL ADI SOYADI</th></tr></thead>
            <tbody id="pBody"></tbody>
        </table>
    </div>

    <div class="notes-box">
        <h3>üìù D√ñNEM NOTLARI</h3>
        <textarea id="aylikNot" oninput="boyutlandir(this)" onchange="notKaydet(this.value)" placeholder="Notlarƒ±nƒ±zƒ± buraya yazƒ±n..."></textarea>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB4zJ0nY_06VnOh-JEmpfhw8EzrvbCiIBA",
        authDomain: "texerp-ea015.firebaseapp.com",
        databaseURL: "https://texerp-ea015-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "texerp-ea015",
        storageBucket: "texerp-ea015.firebasestorage.app",
        messagingSenderId: "531851332664",
        appId: "1:531851332664:web:d2af3d69b6241d7fd8eacd"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const pRef = db.ref("puantaj/personeller");
    const vRef = db.ref("puantaj/kayitlar");
    const aRef = db.ref("puantaj/ayarlar");

    let personeller = {}, tumVeriler = {}, ayarlar = {};

    function boyutlandir(el) {
        el.style.height = 'auto';
        // scrollHeight eƒüer 10 satƒ±rdan (15em) b√ºy√ºkse o boyuta uzar
        el.style.height = (el.scrollHeight) + 'px';
    }

    window.onload = () => {
        const s = document.getElementById('aySecici');
        const aylar = ["OCAK","≈ûUBAT","MART","Nƒ∞SAN","MAYIS","HAZƒ∞RAN","TEMMUZ","AƒûUSTOS","EYL√úL","EKƒ∞M","KASIM","ARALIK"];
        const d = new Date();
        for(let i=0; i<12; i++) {
            let opt = document.createElement('option');
            opt.value = `${d.getFullYear()}-${(i+1).toString().padStart(2,'0')}`;
            opt.text = `${aylar[i]} ${d.getFullYear()}`;
            if(i === d.getMonth()) opt.selected = true;
            s.appendChild(opt);
        }

        const row = document.getElementById('gunlerRow');
        for(let i=1; i<=31; i++) {
            let th = document.createElement('th'); th.innerText = i; row.appendChild(th);
        }
        row.innerHTML += `<th class="summary-col">G√úN</th><th class="summary-col">MAK.</th><th class="money-col">TUTAR</th><th class="no-print" style="width:25px"></th>`;

        pRef.on("value", snap => { personeller = snap.val() || {}; listele(); });
        vRef.on("value", snap => { tumVeriler = snap.val() || {}; listele(); });
        aRef.on("value", snap => { 
            ayarlar = snap.val() || {}; 
            const ayKey = document.getElementById('aySecici').value;
            document.getElementById('birimFiyat').value = ayarlar[ayKey]?.birimFiyat || 0;
            const notArea = document.getElementById('aylikNot');
            notArea.value = ayarlar[ayKey]?.notlar || "";
            setTimeout(() => boyutlandir(notArea), 300);
            listele(); 
        });
    };

    function listele() {
        const s = document.getElementById('aySecici');
        const ayKey = s.value;
        document.getElementById('dynamicTitle').innerText = `MAKROTEKS ${s.options[s.selectedIndex].text} PUANTAJ RAPORU`;
        const body = document.getElementById('pBody');
        const bFiyat = ayarlar[ayKey]?.birimFiyat || 0;
        body.innerHTML = "";

        Object.keys(personeller).forEach(pId => {
            let p = personeller[pId];
            let tGun = 0;
            let rowHtml = `<tr><td class="name-col">${p.ad}</td>`;
            for(let i=1; i<=31; i++) {
                let durum = (tumVeriler[ayKey]?.[pId]?.[i]) || "";
                let cls = durum === 'V' ? 'present' : (durum === 'X' ? 'absent' : '');
                rowHtml += `<td class="day-cell ${cls}" onclick="yoklamaDegistir('${pId}', ${i})">${durum==='V'?'‚úì':(durum==='X'?'X':'')}</td>`;
                if(durum === 'V') tGun++;
            }
            let mVal = (tumVeriler[ayKey]?.[pId]?.makina) || 0;
            let tutar = (mVal * bFiyat).toLocaleString('tr-TR', { minimumFractionDigits: 2 });
            rowHtml += `<td class="summary-col">${tGun}</td>`;
            rowHtml += `<td class="summary-col"><input type="number" step="0.1" value="${mVal}" onchange="makinaKaydet('${pId}', this.value)" style="width:100%; border:none; text-align:center; font-size:10px; font-weight:bold; background:transparent;"></td>`;
            rowHtml += `<td class="money-col">‚Ç∫${tutar}</td>`;
            rowHtml += `<td class="no-print"><button onclick="pSil('${pId}')" style="background:none; color:red; font-weight:bold;">√ó</button></td></tr>`;
            body.innerHTML += rowHtml;
        });
    }

    function yoklamaDegistir(pId, gun) {
        const ayKey = document.getElementById('aySecici').value;
        let mev = (tumVeriler[ayKey]?.[pId]?.[gun]) || "";
        db.ref(`puantaj/kayitlar/${ayKey}/${pId}/${gun}`).set(mev === "V" ? "X" : (mev === "X" ? "" : "V"));
    }
    function makinaKaydet(pId, val) { db.ref(`puantaj/kayitlar/${document.getElementById('aySecici').value}/${pId}/makina`).set(parseFloat(val) || 0); }
    function fiyatKaydet(val) { db.ref(`puantaj/ayarlar/${document.getElementById('aySecici').value}/birimFiyat`).set(parseFloat(val) || 0); }
    function notKaydet(val) { db.ref(`puantaj/ayarlar/${document.getElementById('aySecici').value}/notlar`).set(val); }
    function pEkle() { const inp = document.getElementById('p_ad'); if(inp.value) { pRef.push({ ad: inp.value.toUpperCase() }); inp.value = ""; } }
    function pSil(id) { if(confirm("Silinsin mi?")) pRef.child(id).remove(); }
</script>
</body>
</html>
