<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAKROTEKS Puantaj v11 - Daraltƒ±lmƒ±≈ü</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --border: #000; --gelmedi: #e74c3c; --tick: #000080; --mavi: #007bff; --yesil: #28a745; --bordo: #800000; }
        body { font-family: 'Calibri', 'Arial', sans-serif; background: #fff; margin: 0; padding: 5px; color: #000; }
        
        .container { width: 100%; display: flex; flex-direction: column; align-items: center; }
        h2 { text-align: center; font-size: 14px; margin: 5px 0; font-weight: bold; text-decoration: underline; text-transform: uppercase; }

        .no-print { 
            display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; 
            background: #f4f4f4; padding: 8px; border: 1px solid #ccc; border-radius: 4px; align-items: center; width: fit-content;
        }
        
        input { padding: 3px; border: 1px solid #999; font-size: 12px; }
        .btn { padding: 3px 10px; cursor: pointer; border: 1px solid #333; font-weight: bold; font-size: 12px; }
        .btn-add { background: #e1e1e1; }
        .btn-print { background: #333; color: white; }

        .price-box { background: #fff; border: 2px solid var(--yesil); padding: 3px 8px; border-radius: 5px; display: flex; align-items: center; gap: 5px; }

        .table-wrapper { width: 100%; display: flex; justify-content: center; overflow-x: auto; }
        table { border-collapse: collapse; table-layout: fixed; border: 1.2px solid #000; margin: auto; }
        
        th, td { border: 1px solid var(--border); padding: 0; text-align: center; vertical-align: middle; box-sizing: border-box; height: 22px; }
        
        th { background: var(--mavi) !important; color: white !important; font-weight: bold; font-size: 9px; }
        
        .name-col { text-align: left; padding-left: 5px; width: 160px; font-weight: bold; font-size: 11px; background-color: #f2f2f2 !important; color: #000 !important; }
        
        th.green-head { background: var(--yesil) !important; }
        th.bordo-head { background: var(--bordo) !important; color: white; }

        .day-cell { cursor: pointer; width: 22px !important; font-size: 10px; background-color: #fff; }
        
        .present { color: var(--tick) !important; font-size: 14px; font-weight: 900; } 
        .absent { color: var(--gelmedi) !important; font-size: 13px; font-weight: 900; } 
        
        /* G√úN SAYISI S√úTUNU: 14 punto, Kalƒ±n, Siyah ve A√ßƒ±k Gri Arka Plan */
        .summary-col { 
            background: #f2f2f2 !important; 
            color: #000 !important; 
            font-weight: bold !important; 
            width: 35px; 
            font-size: 14px !important; 
        }

        .calc-col { width: 55px; background: var(--yesil) !important; color: white; font-weight: bold; font-size: 11px; }
        .calc-input { width: 100%; border: none; text-align: center; background: transparent; font-weight: bold; height: 20px; color: white; font-size: 11px; }
        
        .action-col { width: 30px; border: 1px solid var(--border) !important; background-color: #fff; }
        .btn-sil { color: var(--bordo); border: none; background: none; cursor: pointer; font-size: 16px; font-weight: bold; line-height: 1; }

        .note-container { width: 95%; max-width: 1000px; margin-top: 10px; border: 1.2px solid var(--border); padding: 5px; }
        textarea { width: 100%; border: none; outline: none; resize: none; font-size: 12px; min-height: 40px; }

        @media print {
            .no-print, .action-col, .bordo-head { display: none !important; }
            th { background-color: #007bff !important; color: white !important; -webkit-print-color-adjust: exact; }
            .name-col { background-color: #f2f2f2 !important; color: black !important; -webkit-print-color-adjust: exact; }
            .summary-col { background-color: #f2f2f2 !important; color: black !important; -webkit-print-color-adjust: exact; }
            .green-head, .calc-col { background-color: #28a745 !important; color: white !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2 id="baslik">PERSONEL PUANTAJ VE MAKƒ∞NA FARKI Lƒ∞STESƒ∞</h2>

    <div class="no-print">
        <input type="text" id="p_name" placeholder="Personel Adƒ±" style="width: 150px;">
        <button class="btn btn-add" onclick="personelEkle()">EKLE</button>
        <input type="month" id="selectedMonth" onchange="verileriYukle()">
        
        <div class="price-box">
            <strong style="font-size:11px; color:var(--yesil)">MAKƒ∞NA Bƒ∞Rƒ∞M:</strong>
            <input type="number" id="unitPrice" value="0" step="0.01" style="width: 60px;" oninput="hesaplaHepsini()">
        </div>

        <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è YAZDIR</button>
    </div>

    <div class="table-wrapper">
        <table id="puantajTable">
            <thead>
                <tr id="headerRow"></tr>
            </thead>
            <tbody id="puantajBody"></tbody>
        </table>
    </div>

    <div class="note-container">
        <strong style="font-size: 12px;">PUANTAJ NOTLARI / A√áIKLAMALAR</strong>
        <textarea id="aylikNot" placeholder="Not ekle..." oninput="notuKaydet()"></textarea>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAeFLhVyrv4sn4kJmUtusLIOPWwgmKxe5c",
        authDomain: "kumastakip-6930a.firebaseapp.com",
        databaseURL: "https://kumastakip-6930a-default-rtdb.firebaseio.com",
        projectId: "kumastakip-6930a",
        storageBucket: "kumastakip-6930a.firebasestorage.app",
        messagingSenderId: "796676836408",
        appId: "1:796676836408:web:cf74345b2a412cb1c26acd"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    document.getElementById('selectedMonth').value = new Date().toISOString().substring(0, 7);

    function personelEkle() {
        const ad = document.getElementById('p_name').value.trim();
        if(!ad) return;
        db.ref('personeller').push({ ad: ad.toUpperCase(), eklemeTarihi: Date.now() });
        document.getElementById('p_name').value = "";
    }

    function yoklamaTetikle(pId, gun) {
        const ayKey = document.getElementById('selectedMonth').value.replace("-", "_");
        const ref = db.ref(`puantaj/${ayKey}/${pId}/${gun}`);
        ref.once('value', snap => {
            const val = snap.val();
            if(!val) ref.set("V");
            else if(val === "V") ref.set("X");
            else ref.remove();
        });
    }

    function makinaKaydet(pId, adet) {
        const ayKey = document.getElementById('selectedMonth').value.replace("-", "_");
        db.ref(`makina_farki/${ayKey}/${pId}`).set(adet);
    }

    function hesaplaHepsini() {
        const birimFiyat = parseFloat(document.getElementById('unitPrice').value) || 0;
        const inputs = document.querySelectorAll('.m-adet');
        inputs.forEach(input => {
            const pId = input.getAttribute('data-id');
            const adet = parseFloat(input.value) || 0;
            const sonuc = adet * birimFiyat;
            document.getElementById(`tutar-${pId}`).innerText = sonuc.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " TL";
        });
    }

    let saveTimeout;
    function notuKaydet() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            const ayKey = document.getElementById('selectedMonth').value.replace("-", "_");
            db.ref(`notlar/${ayKey}`).set(document.getElementById('aylikNot').value);
        }, 1000);
    }

    function verileriYukle() {
        const ayStr = document.getElementById('selectedMonth').value;
        const ayKey = ayStr.replace("-", "_");
        const [yil, ay] = ayStr.split("-");
        const gunSayisi = new Date(yil, ay, 0).getDate();
        
        const ayIsimler = ["OCAK", "≈ûUBAT", "MART", "Nƒ∞SAN", "MAYIS", "HAZƒ∞RAN", "TEMMUZ", "AƒûUSTOS", "EYL√úL", "EKƒ∞M", "KASIM", "ARALIK"];
        document.getElementById('baslik').innerText = `${ayIsimler[parseInt(ay)-1]} ${yil} PUANTAJ VE MAKƒ∞NA FARKI`;

        db.ref(`notlar/${ayKey}`).once('value', snap => { document.getElementById('aylikNot').value = snap.val() || ""; });

        const headerRow = document.getElementById('headerRow');
        headerRow.innerHTML = `<th class="name-col" style="text-align:center">PERSONEL ADI</th>`;
        for(let i=1; i<=gunSayisi; i++) { 
            headerRow.innerHTML += `<th class="day-cell" style="background:var(--mavi); color:white;">${i}</th>`; 
        }
        /* Ba≈ülƒ±k kƒ±smƒ±ndaki G√úN h√ºcresi de a√ßƒ±k gri yapƒ±ldƒ± */
        headerRow.innerHTML += `<th class="summary-col" style="background:#f2f2f2 !important; color:#000 !important;">G√úN</th>`;
        headerRow.innerHTML += `<th class="calc-col green-head">MAKƒ∞NA</th>`;
        headerRow.innerHTML += `<th class="calc-col green-head" style="width:70px">TUTAR</th>`;
        headerRow.innerHTML += `<th class="no-print bordo-head">Sƒ∞L</th>`;

        db.ref('personeller').on('value', pSnap => {
            db.ref(`puantaj/${ayKey}`).on('value', puSnap => {
                db.ref(`makina_farki/${ayKey}`).on('value', mSnap => {
                    const personeller = pSnap.val() || {};
                    const yoklamalar = puSnap.val() || {};
                    const makinalar = mSnap.val() || {};
                    const body = document.getElementById('puantajBody');
                    body.innerHTML = "";

                    const siraliKeys = Object.keys(personeller).sort((a,b) => (personeller[a].eklemeTarihi || 0) - (personeller[b].eklemeTarihi || 0));

                    siraliKeys.forEach((pId, index) => {
                        const p = personeller[pId];
                        const p_yoklama = yoklamalar[pId] || {};
                        const m_adet = makinalar[pId] || 0;
                        let toplamGun = 0;

                        let rowHtml = `<tr><td class="name-col">${index + 1}. ${p.ad}</td>`;
                        for(let i=1; i<=gunSayisi; i++) {
                            const durum = p_yoklama[i];
                            let content = "";
                            let cls = "day-cell";
                            if(durum === "V") { content = "‚úì"; cls += " present"; toplamGun++; }
                            else if(durum === "X") { content = "X"; cls += " absent"; }
                            
                            rowHtml += `<td class="${cls}" onclick="yoklamaTetikle('${pId}', ${i})">${content}</td>`;
                        }
                        rowHtml += `<td class="summary-col">${toplamGun}</td>`;
                        rowHtml += `<td class="calc-col"><input type="number" class="calc-input m-adet" data-id="${pId}" value="${m_adet}" onchange="makinaKaydet('${pId}', this.value)"></td>`;
                        rowHtml += `<td class="calc-col" id="tutar-${pId}" style="font-size:10px">0.00 TL</td>`;
                        rowHtml += `<td class="no-print action-col"><button class="btn-sil" onclick="pSil('${pId}')">√ó</button></td></tr>`;
                        body.innerHTML += rowHtml;
                    });
                    hesaplaHepsini();
                });
            });
        });
    }

    function pSil(id) { if(confirm("Bu personeli silmek istediƒüinize emin misiniz?")) db.ref('personeller/'+id).remove(); }
    verileriYukle();
</script>

</body>
</html>