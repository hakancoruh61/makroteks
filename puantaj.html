<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAKROTEKS Puantaj - Bulut Sistemi</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --border: #000; --gelmedi: #e74c3c; --tick: #000080; --mavi: #007bff; --yesil: #28a745; }
        body { font-family: 'Calibri', 'Arial', sans-serif; background: #fff; margin: 0; padding: 5px; color: #000; }
        .container { width: 100%; display: flex; flex-direction: column; align-items: center; }
        h2 { text-align: center; font-size: 16px; margin: 10px 0; font-weight: bold; text-decoration: underline; text-transform: uppercase; }
        .no-print { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; background: #f4f4f4; padding: 10px; border: 1px solid #ccc; border-radius: 4px; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 5px; table-layout: fixed; }
        th, td { border: 1px solid var(--border); padding: 2px; text-align: center; font-size: 11px; overflow: hidden; }
        th { background: #f2f2f2; font-weight: bold; }
        
        .name-col { width: 150px; text-align: left; padding-left: 5px; font-weight: bold; white-space: nowrap; }
        .day-cell { cursor: pointer; font-weight: bold; width: 25px; }
        .present { color: var(--tick); background: #e2f0d9; }
        .absent { color: var(--gelmedi); background: #fbe5d6; }
        .summary-col { background: #fff2cc; font-weight: bold; width: 40px; }
        .calc-col { background: #deebf7; width: 60px; }
        .calc-input { width: 90%; border: none; background: transparent; text-align: center; font-weight: bold; }
        
        button { padding: 5px 10px; cursor: pointer; font-weight: bold; }
        .btn-ekle { background: var(--yesil); color: white; border: none; }
        .btn-sil { background: var(--gelmedi); color: white; border: none; padding: 2px 5px; }
        
        @media print { .no-print { display: none !important; } body { margin: 0; padding: 0; } }
    </style>
</head>
<body>

<div class="container">
    <h2>MAKROTEKS PERSONEL PUANTAJ VE ÜRETİM TAKİBİ</h2>

    <div class="no-print">
        <select id="aySecici" onchange="listele()"></select>
        <input type="text" id="p_ad" placeholder="Personel Adı Soyadı">
        <button class="btn-ekle" onclick="pEkle()">PERSONEL EKLE</button>
        <button onclick="window.print()" style="background:#555; color:white; border:none;">YAZDIR (PDF)</button>
        <div id="connStatus" style="color: green; font-size: 12px; margin-left: 10px;">● Bulut Aktif</div>
    </div>

    <table>
        <thead>
            <tr id="gunlerRow">
                <th class="name-col">PERSONEL ADI SOYADI</th>
                </tr>
        </thead>
        <tbody id="pBody"></tbody>
    </table>
</div>

<script>
    // FİREBASE YAPILANDIRMASI
    const firebaseConfig = {
        apiKey: "AIzaSyB4zJ0nY_06VnOh-JEmpfhw8EzrvbCiIBA",
        authDomain: "texerp-ea015.firebaseapp.com",
        databaseURL: "https://texerp-ea015-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "texerp-ea015",
        storageBucket: "texerp-ea015.firebasestorage.app",
        messagingSenderId: "531851332664",
        appId: "1:531851332664:web:d2af3d69b6241d7fd8eacd"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Veri Referansları
    const personelRef = db.ref("puantaj/personeller");
    const veriRef = db.ref("puantaj/kayitlar"); // Yoklama ve Makine verileri

    let personeller = {};
    let tumVeriler = {};

    // Sayfa Başlatma
    window.onload = () => {
        ay SeciciDoldur();
        gunleriOlustur();
        verileriYukle();
    };

    function aySeciciDoldur() {
        const secici = document.getElementById('aySecici');
        const aylar = ["OCAK","ŞUBAT","MART","NİSAN","MAYIS","HAZİRAN","TEMMUZ","AĞUSTOS","EYLÜL","EKİM","KASIM","ARALIK"];
        const d = new Date();
        const yil = d.getFullYear();
        
        for(let i=0; i<12; i++) {
            let option = document.createElement('option');
            let ayIndex = (i + 1).toString().padStart(2, '0');
            option.value = `${yil}-${ayIndex}`;
            option.text = `${aylar[i]} ${yil}`;
            if(i === d.getMonth()) option.selected = true;
            secici.appendChild(option);
        }
    }

    function gunleriOlustur() {
        const row = document.getElementById('gunlerRow');
        for(let i=1; i<=31; i++) {
            let th = document.createElement('th');
            th.innerText = i;
            th.style.width = "25px";
            row.appendChild(th);
        }
        row.innerHTML += `<th class="summary-col">TOP</th><th class="calc-col">MAKİNA</th><th class="no-print" style="width:30px">SİL</th>`;
    }

    function verileriYukle() {
        // Personelleri Dinle
        personelRef.on("value", (snap) => {
            personeller = snap.val() || {};
            listele();
        });

        // Tüm Puantaj Verisini Dinle
        veriRef.on("value", (snap) => {
            tumVeriler = snap.val() || {};
            listele();
        });
    }

    function pEkle() {
        const ad = document.getElementById('p_ad').value.trim().toUpperCase();
        if(!ad) return;
        personelRef.push({ ad: ad });
        document.getElementById('p_ad').value = "";
    }

    function listele() {
        const ayKey = document.getElementById('aySecici').value;
        const body = document.getElementById('pBody');
        body.innerHTML = "";

        Object.keys(personeller).forEach(pId => {
            let p = personeller[pId];
            let rowHtml = `<tr><td class="name-col">${p.ad}</td>`;
            let toplamGun = 0;

            for(let i=1; i<=31; i++) {
                let durum = (tumVeriler[ayKey] && tumVeriler[ayKey][pId] && tumVeriler[ayKey][pId][i]) ? tumVeriler[ayKey][pId][i] : "";
                let cls = "day-cell";
                let content = "";
                
                if(durum === "V") { content = "✓"; cls += " present"; toplamGun++; }
                else if(durum === "X") { content = "X"; cls += " absent"; }
                
                rowHtml += `<td class="${cls}" onclick="yoklamaDegistir('${pId}', ${i})">${content}</td>`;
            }

            let makina = (tumVeriler[ayKey] && tumVeriler[ayKey][pId] && tumVeriler[ayKey][pId]['makina']) ? tumVeriler[ayKey][pId]['makina'] : 0;
            
            rowHtml += `<td class="summary-col">${toplamGun}</td>`;
            rowHtml += `<td class="calc-col"><input type="number" class="calc-input" value="${makina}" onchange="makinaKaydet('${pId}', this.value)"></td>`;
            rowHtml += `<td class="no-print"><button class="btn-sil" onclick="pSil('${pId}')">×</button></td></tr>`;
            body.innerHTML += rowHtml;
        });
    }

    function yoklamaDegistir(pId, gun) {
        const ayKey = document.getElementById('aySecici').value;
        let mevcut = (tumVeriler[ayKey] && tumVeriler[ayKey][pId] && tumVeriler[ayKey][pId][gun]) ? tumVeriler[ayKey][pId][gun] : "";
        let yeni = mevcut === "V" ? "X" : (mevcut === "X" ? "" : "V");
        
        db.ref(`puantaj/kayitlar/${ayKey}/${pId}/${gun}`).set(yeni);
    }

    function makinaKaydet(pId, deger) {
        const ayKey = document.getElementById('aySecici').value;
        db.ref(`puantaj/kayitlar/${ayKey}/${pId}/makina`).set(parseFloat(deger) || 0);
    }

    function pSil(id) {
        if(confirm("Bu personeli ve tüm kayıtlarını silmek istediğinize emin misiniz?")) {
            personelRef.child(id).remove();
            // Not: Personel silindiğinde o aya ait veriler veritabanında kalır ama listelenmez. 
            // Tam temizlik için kayitlar altından da silinebilir.
        }
    }
</script>
</body>
</html>