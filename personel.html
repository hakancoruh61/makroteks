<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAKROTEKS Personel Y√∂netimi - v20.0</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #1a73e8; --success: #28a745; --danger: #dc3545; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; margin: 10px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 100%; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); padding-bottom: 8px; margin-bottom: 15px; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 15px; align-items: end; }
        .input-group { display: flex; flex-direction: column; gap: 4px; }
        .input-group label { font-size: 10px; font-weight: bold; color: #555; text-transform: uppercase; }
        .input-group input, .input-group select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 11px; }
        th, td { border: 1px solid #999; padding: 8px 4px; text-align: center; }
        th { background: var(--dark); color: white; }
        .personel-row { cursor: pointer; transition: background 0.2s; }
        .personel-row:hover { background-color: #f1f3f5 !important; }
        
        .action-tray { display: none; background: #f8f9fa; border: 1px solid #ddd; }
        .action-content { display: flex; gap: 20px; justify-content: center; padding: 10px; align-items: center; }
        .btn-action { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; display: flex; align-items: center; gap: 5px; }

        .toplam-satir { background: #dfe6e9 !important; font-weight: 800; font-size: 11px; }
        .btn-add { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; height: 38px; }
        .status-paid { color: white; background: var(--success); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        .status-unpaid { color: white; background: var(--danger); padding: 2px 6px; border-radius: 4px; font-size: 10px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 450px; border-radius: 12px; }

        @media print { 
            .no-print { display: none !important; } 
            .action-tray { display: none !important; }
            /* Rapor √ßƒ±ktƒ±sƒ±nda DURUM s√ºtununu gizleme (11. s√ºtun) */
            th:nth-child(11), td:nth-child(11) { display: none !important; }
            table { width: 100%; border: 1px solid #000; }
            th, td { border: 1px solid #000 !important; color: #000 !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 id="sayfaBaslik" style="margin:0; font-size: 18px; text-transform: uppercase;">üë§ PERSONEL MAA≈û Y√ñNETƒ∞Mƒ∞</h2>
        <div id="status" style="color: green; font-weight: bold; font-size: 11px;">‚óè Bulut Baƒülantƒ±sƒ± Aktif</div>
    </div>

    <div class="form-grid no-print">
        <div class="input-group"><label>Ad Soyad</label><input type="text" id="p_ad"></div>
        <div class="input-group"><label>B√∂l√ºm</label><input type="text" id="p_bolum"></div>
        <div class="input-group"><label>Maa≈ü</label><input type="number" id="p_maas"></div>
        <div class="input-group"><label>G√ºn</label><input type="number" id="p_gun" value="30"></div>
        <div class="input-group"><label>Mesai</label><input type="number" id="p_mesai" value="0"></div>
        <div class="input-group"><label>MK Farkƒ±</label><input type="number" id="p_prim" value="0"></div>
        <div class="input-group"><label>Kesinti</label><input type="number" id="p_kesinti" value="0"></div>
        <button class="btn-add" onclick="yeniKaydet()">KAYDET</button>
    </div>

    <div class="no-print" style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px; background: #fff3cd; padding: 10px; border-radius: 8px;">
        <label style="font-weight: bold; font-size: 12px;">D√ñNEM Fƒ∞LTRESƒ∞:</label>
        <select id="ayFiltre" onchange="listele()" style="padding:6px; border-radius:4px; border:1px solid #856404; min-width: 160px;"></select>
        <button onclick="window.print()" style="background:var(--dark); color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">üñ®Ô∏è YAZDIR</button>
        <button onclick="excelIndir()" style="background:#1d6f42; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">üìä EXCEL</button>
    </div>

    <table id="maasTablosu">
        <thead>
            <tr>
                <th>#</th>
                <th style="text-align:left">Ad Soyad</th>
                <th>B√∂l√ºm</th>
                <th>Maa≈ü</th>
                <th>1 G√ºnl√ºk</th>
                <th>G√ºn</th>
                <th>Mesai</th>
                <th>MK Farkƒ±</th>
                <th>Kesinti</th>
                <th>Net √ñdenen</th>
                <th>Durum</th>
            </tr>
        </thead>
        <tbody id="personelBody"></tbody>
        <tfoot id="toplamFoot"></tfoot>
    </table>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <div style="font-weight:bold; border-bottom:2px solid var(--primary); padding-bottom:10px; margin-bottom:15px;">‚úèÔ∏è PERSONEL G√úNCELLE</div>
        <input type="hidden" id="edit_id">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div class="input-group"><label>Ad Soyad</label><input type="text" id="e_ad"></div>
            <div class="input-group"><label>B√∂l√ºm</label><input type="text" id="e_bolum"></div>
            <div class="input-group"><label>Maa≈ü</label><input type="number" id="e_maas"></div>
            <div class="input-group"><label>G√ºn</label><input type="number" id="e_gun"></div>
            <div class="input-group"><label>Mesai</label><input type="number" id="e_mesai"></div>
            <div class="input-group"><label>MK Farkƒ±</label><input type="number" id="e_prim"></div>
            <div class="input-group"><label>Kesinti</label><input type="number" id="e_kesinti"></div>
            <div class="input-group"><label>Durum</label><select id="e_durum"><option value="√ñdenmedi">√ñdenmedi</option><option value="√ñdendi">√ñdendi</option></select></div>
        </div>
        <div class="input-group" style="margin-top:10px;"><label>Notlar</label><textarea id="e_notlar" style="height:50px; resize:none;"></textarea></div>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button class="btn-add" style="flex:1; background:var(--success);" onclick="guncelleKaydet()">G√úNCELLE</button>
            <button class="btn-add" style="flex:1; background:#6c757d;" onclick="document.getElementById('editModal').style.display='none'">ƒ∞PTAL</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB4zJ0nY_06VnOh-JEmpfhw8EzrvbCiIBA",
        authDomain: "texerp-ea015.firebaseapp.com",
        databaseURL: "https://texerp-ea015-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "texerp-ea015"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const personelRef = db.ref("personel_yonetimi");

    let tumVeriler = {};

    function yeniKaydet() {
        const ad = document.getElementById('p_ad').value;
        if(!ad) return alert("ƒ∞sim giriniz!");
        const donem = new Date().toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' }).toUpperCase().trim();
        
        const veri = {
            ad: ad.toUpperCase().trim(),
            bolum: document.getElementById('p_bolum').value.toUpperCase().trim(),
            maas: parseFloat(document.getElementById('p_maas').value) || 0,
            gun: parseFloat(document.getElementById('p_gun').value) || 0,
            mesai: parseFloat(document.getElementById('p_mesai').value) || 0,
            prim: parseFloat(document.getElementById('p_prim').value) || 0,
            kesinti: parseFloat(document.getElementById('p_kesinti').value) || 0,
            durum: "√ñdenmedi",
            donem: donem,
            tarih: Date.now() 
        };
        personelRef.push(veri).then(() => {
            document.querySelectorAll('.form-grid input').forEach(i => i.id === 'p_gun' ? i.value='30' : (i.type==='number' ? i.value='0' : i.value=''));
        });
    }

    personelRef.on("value", (snap) => { 
        tumVeriler = snap.val() || {};
        filtreGuncelle();
        listele();
    });

    function filtreGuncelle() {
        const ayFiltre = document.getElementById('ayFiltre');
        const suAnki = ayFiltre.value;
        const donemler = [...new Set(Object.values(tumVeriler).map(i => (i.donem || "Bƒ∞Lƒ∞NMEYEN").toUpperCase().trim()))];
        let html = '<option value="Hepsi">T√ºm D√∂nemler</option>';
        donemler.forEach(d => html += `<option value="${d}" ${d === suAnki ? 'selected' : ''}>${d}</option>`);
        ayFiltre.innerHTML = html;
    }

    function listele() {
        const body = document.getElementById('personelBody');
        const filtre = document.getElementById('ayFiltre').value;
        body.innerHTML = "";
        
        const liste = Object.keys(tumVeriler).map(key => ({ id: key, ...tumVeriler[key] }));
        liste.sort((a,b) => (a.tarih || 0) - (b.tarih || 0));

        document.getElementById('sayfaBaslik').innerText = (filtre === "Hepsi") ? "üë§ PERSONEL MAA≈û RAPORU" : "üë§ PERSONEL MAA≈û RAPORU - " + filtre;

        let t_maas=0, t_mesai=0, t_prim=0, t_kesinti=0, t_net=0, sayac=1;

        liste.forEach(p => {
            const pDonem = (p.donem || "").toUpperCase().trim();
            if(filtre !== "Hepsi" && pDonem !== filtre) return;
            
            const gunluk = (p.maas || 0) / 30;
            const net = ((gunluk * (p.gun || 0)) + (p.mesai || 0) + (p.prim || 0)) - (p.kesinti || 0);
            
            t_maas += (p.maas || 0);
            t_mesai += (p.mesai || 0);
            t_prim += (p.prim || 0);
            t_kesinti += (p.kesinti || 0);
            t_net += net;

            body.innerHTML += `
                <tr class="personel-row" onclick="toggleActions('${p.id}')">
                    <td>${sayac++}</td>
                    <td style="text-align:left; font-weight:bold">${p.ad}</td>
                    <td>${p.bolum}</td>
                    <td>${(p.maas || 0).toLocaleString()}</td>
                    <td>${gunluk.toFixed(2)}</td>
                    <td>${p.gun || 0}</td>
                    <td>${(p.mesai || 0).toLocaleString()}</td>
                    <td>${(p.prim || 0).toLocaleString()}</td>
                    <td>${(p.kesinti || 0).toLocaleString()}</td>
                    <td style="font-weight:bold; color:var(--primary)">${net.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
                    <td><span class="${p.durum === '√ñdendi' ? 'status-paid' : 'status-unpaid'}">${p.durum}</span></td>
                </tr>
                <tr id="tray-${p.id}" class="action-tray">
                    <td colspan="11">
                        <div class="action-content">
                            <span style="color:#666">Not: ${p.ozelNotlar || '-'}</span>
                            <button class="btn-action" style="background:var(--primary); color:white;" onclick="event.stopPropagation(); duzenle('${p.id}')">‚úèÔ∏è D√úZENLE</button>
                            <button class="btn-action" style="background:var(--success); color:white;" onclick="event.stopPropagation(); durumDegistir('${p.id}','${p.durum}')">‚úÖ DURUMU DEƒûƒ∞≈ûTƒ∞R</button>
                            <button class="btn-action" style="background:var(--danger); color:white;" onclick="event.stopPropagation(); sil('${p.id}')">üóëÔ∏è Sƒ∞L</button>
                        </div>
                    </td>
                </tr>`;
        });

        // TOPLAM FOOTER SATIRI
        document.getElementById('toplamFoot').innerHTML = `
            <tr class="toplam-satir">
                <td colspan="3" style="text-align:right">GENEL TOPLAM:</td>
                <td>${t_maas.toLocaleString()} ‚Ç∫</td>
                <td>-</td>
                <td>-</td>
                <td>${t_mesai.toLocaleString()} ‚Ç∫</td>
                <td>${t_prim.toLocaleString()} ‚Ç∫</td>
                <td>${t_kesinti.toLocaleString()} ‚Ç∫</td>
                <td style="color:var(--primary)">${t_net.toLocaleString(undefined,{minimumFractionDigits:2})} ‚Ç∫</td>
                <td></td>
            </tr>`;
    }

    function toggleActions(id) {
        const tray = document.getElementById('tray-' + id);
        const isVisible = tray.style.display === 'table-row';
        document.querySelectorAll('.action-tray').forEach(t => t.style.display = 'none');
        tray.style.display = isVisible ? 'none' : 'table-row';
    }

    function duzenle(id) {
        const p = tumVeriler[id];
        document.getElementById('edit_id').value = id;
        document.getElementById('e_ad').value = p.ad;
        document.getElementById('e_bolum').value = p.bolum;
        document.getElementById('e_maas').value = p.maas;
        document.getElementById('e_gun').value = p.gun;
        document.getElementById('e_mesai').value = p.mesai || 0;
        document.getElementById('e_prim').value = p.prim || 0;
        document.getElementById('e_kesinti').value = p.kesinti || 0;
        document.getElementById('e_durum').value = p.durum;
        document.getElementById('e_notlar').value = p.ozelNotlar || "";
        document.getElementById('editModal').style.display = 'block';
    }

    function guncelleKaydet() {
        const id = document.getElementById('edit_id').value;
        const veri = {
            ad: document.getElementById('e_ad').value.toUpperCase().trim(),
            bolum: document.getElementById('e_bolum').value.toUpperCase().trim(),
            maas: parseFloat(document.getElementById('e_maas').value) || 0,
            gun: parseFloat(document.getElementById('e_gun').value) || 0,
            mesai: parseFloat(document.getElementById('e_mesai').value) || 0,
            prim: parseFloat(document.getElementById('e_prim').value) || 0,
            kesinti: parseFloat(document.getElementById('e_kesinti').value) || 0,
            durum: document.getElementById('e_durum').value,
            ozelNotlar: document.getElementById('e_notlar').value
        };
        personelRef.child(id).update(veri).then(() => document.getElementById('editModal').style.display='none');
    }

    function excelIndir() {
        const tablo = document.getElementById("maasTablosu");
        const wb = XLSX.utils.table_to_book(tablo, {sheet: "Rapor"});
        XLSX.writeFile(wb, "Personel_Maas_Raporu.xlsx");
    }

    function durumDegistir(id, m) { personelRef.child(id).update({ durum: m === "√ñdendi" ? "√ñdenmedi" : "√ñdendi" }); }
    function sil(id) { if(confirm("Silmek istediƒüinize emin misiniz?")) personelRef.child(id).remove(); }
</script>
</body>
</html>
