<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAKROTEKS ƒ∞plik Stok v8.6 - Hatasƒ±z Filtreleme</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #3498db; --secondary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --info: #9b59b6; --warning: #f39c12; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: var(--secondary); text-align: center; border-bottom: 3px solid var(--primary); padding-bottom: 10px; }
        
        .form-grup { background: #ffffff; padding: 20px; border-radius: 8px; border: 1px solid #dcdde1; margin-bottom: 30px; }
        .form-satir { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .input-alan { display: flex; flex-direction: column; flex: 1; min-width: 160px; }
        label { font-weight: 600; margin-bottom: 5px; font-size: 13px; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; outline: none; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-kaydet { background: var(--success); }
        .btn-iptal { background: var(--danger); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #dcdde1; padding: 12px; text-align: center; }
        th { background: var(--secondary); color: white; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        
        .row-main { cursor: pointer; transition: background 0.2s; }
        .row-main:hover { background-color: #e1f5fe !important; }
        .lot-detail-row { display: none; background: #fdfdfd !important; animation: fadeIn 0.3s; }
        .lot-container { padding: 15px; background: #fff; border: 2px solid var(--primary); border-radius: 8px; margin: 5px; text-align: left; }
        .lot-badge { display: inline-block; background: var(--info); color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; margin-right: 10px; font-weight: bold; }
        
        .btn-plus { background: var(--success); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .btn-minus { background: var(--warning); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        
        /* Yeni Stil */
        .cinsi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .btn-ekle-kucuk { background: var(--primary); color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 10px; cursor: pointer; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .toplam-satir { background: #dfe6e9 !important; font-weight: bold; font-size: 16px; }
        #connStatus { float: right; font-size: 12px; color: green; font-weight: bold; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="container">
    <div id="connStatus">‚óè Bulut Baƒülantƒ±sƒ± Aktif</div>
    <h1>üß∂ ƒ∞PLƒ∞K DEPO STOK TAKƒ∞Bƒ∞</h1>

    <div class="form-grup no-print">
        <h3 id="formBaslik">‚ûï Yeni ƒ∞plik Giri≈üi</h3>
        <input type="hidden" id="edit_id">
        <div class="form-satir">
            <div class="input-alan">
                <label>Firma Adƒ±</label>
                <input type="text" id="inp_firma" placeholder="Tedarik√ßi Firma">
            </div>
            <div class="input-alan">
                <div class="cinsi-header">
                    <label style="margin-bottom:0">ƒ∞plik Cinsi</label>
                    <button type="button" class="btn-ekle-kucuk" onclick="yeniCinsTanimla()">+ Yeni Tanƒ±mla</button>
                </div>
                <select id="inp_cinsi">
                    <option value="">Se√ßiniz...</option>
                </select>
            </div>
            <div class="input-alan">
                <label>Lot No</label>
                <input type="text" id="inp_lot" placeholder="Lot 1, Lot 2...">
            </div>
            <div class="input-alan">
                <label>Miktar (KG)</label>
                <input type="number" id="inp_kg" step="0.01" placeholder="0.00">
            </div>
            <div class="input-alan">
                <label>Tarih</label>
                <input type="date" id="inp_tarih">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-kaydet" id="btn_ana" onclick="kaydet()">BULUTA KAYDET</button>
                <button class="btn btn-iptal" id="btn_iptal" onclick="formuTemizle()" style="display:none;">ƒ∞PTAL</button>
            </div>
        </div>
    </div>

    <div class="no-print" style="margin-bottom: 15px; display: flex; gap: 20px; align-items: center; background: #e9ecef; padding: 10px; border-radius: 5px;">
        <div>
            <strong>Firma Filtrele:</strong>
            <select id="filtre_firma" onchange="listele()" style="margin-left:10px; padding:5px;"></select>
        </div>
        <small style="color: #64748b;">* Lot detaylarƒ±nƒ± ve <b>+/- Miktar</b> i≈ülemlerini g√∂rmek i√ßin satƒ±ra tƒ±klayƒ±n.</small>
        <button onclick="window.print()" style="padding: 5px 15px; margin-left: auto;">üñ®Ô∏è Yazdƒ±r / PDF</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Tarih</th>
                <th>Firma</th>
                <th>ƒ∞plik Cinsi</th>
                <th>Toplam Stok (KG)</th>
                <th class="no-print">Durum</th>
            </tr>
        </thead>
        <tbody id="stokBody"></tbody>
        <tfoot>
            <tr class="toplam-satir">
                <td colspan="3">Lƒ∞STELENEN GENEL TOPLAM</td>
                <td id="genelToplam">0.00 KG</td>
                <td class="no-print"></td>
            </tr>
        </tfoot>
    </table>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB4zJ0nY_06VnOh-JEmpfhw8EzrvbCiIBA",
        authDomain: "texerp-ea015.firebaseapp.com",
        databaseURL: "https://texerp-ea015-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "texerp-ea015"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const iplikRef = db.ref("iplik_stoklari");
    const cinslerRef = db.ref("iplik_cinsleri"); // Yeni cins tanƒ±mlarƒ± i√ßin ref

    let tumVeriler = {};

    document.getElementById('inp_tarih').valueAsDate = new Date();

    // ƒ∞plik Cinslerini Getir
    cinslerRef.on("value", (snap) => {
        const cinsler = snap.val() || {};
        const select = document.getElementById('inp_cinsi');
        const mevcutSecim = select.value;
        select.innerHTML = '<option value="">Se√ßiniz...</option>';
        Object.values(cinsler).sort().forEach(c => {
            select.innerHTML += `<option value="${c}" ${c === mevcutSecim ? 'selected' : ''}>${c}</option>`;
        });
    });

    function yeniCinsTanimla() {
        const yeniCins = prompt("Yeni ƒ∞plik Cinsini Yazƒ±n (√ñrn: 30/1 PENYE):");
        if (yeniCins) {
            const formatli = yeniCins.toUpperCase().trim();
            cinslerRef.push(formatli);
        }
    }

    function kaydet() {
        const id = document.getElementById('edit_id').value;
        const veri = {
            firma: document.getElementById('inp_firma').value.toUpperCase().trim(),
            cinsi: document.getElementById('inp_cinsi').value,
            lot: document.getElementById('inp_lot').value.toUpperCase().trim(),
            kg: parseFloat(document.getElementById('inp_kg').value) || 0,
            tarih: document.getElementById('inp_tarih').value,
            ts: Date.now()
        };

        if(!veri.firma || !veri.kg || !veri.cinsi) return alert("L√ºtfen Firma, Cinsi ve KG bilgilerini doldurun!");

        if(id) {
            iplikRef.child(id).set(veri).then(() => { formuTemizle(); });
        } else {
            iplikRef.push(veri).then(() => formuTemizle());
        }
    }

    iplikRef.on("value", (snap) => {
        tumVeriler = snap.val() || {};
        filtreGuncelle(tumVeriler);
        listele();
    });

    function listele() {
        const body = document.getElementById('stokBody');
        const filtre = document.getElementById('filtre_firma').value;
        body.innerHTML = "";
        let genelToplamKG = 0;

        if(!tumVeriler || Object.keys(tumVeriler).length === 0) {
            document.getElementById('genelToplam').innerText = "0.00 KG";
            return;
        }

        const liste = Object.keys(tumVeriler).map(k => ({id: k, ...tumVeriler[k]}));
        
        const gruplanmis = {};
        liste.forEach(item => {
            if(filtre && filtre !== "T√úM√ú" && item.firma !== filtre) return;

            const anahtar = `${item.firma}-${item.cinsi}`;
            if(!gruplanmis[anahtar]) {
                gruplanmis[anahtar] = {
                    firma: item.firma,
                    cinsi: item.cinsi,
                    tarih: item.tarih,
                    toplamKg: 0,
                    lotlar: []
                };
            }
            gruplanmis[anahtar].toplamKg += item.kg;
            gruplanmis[anahtar].lotlar.push(item);
            if(new Date(item.tarih) > new Date(gruplanmis[anahtar].tarih)) gruplanmis[anahtar].tarih = item.tarih;
        });

        const gruplanmisDizi = Object.values(gruplanmis);
        if(gruplanmisDizi.length === 0) {
            body.innerHTML = "<tr><td colspan='5'>Se√ßili firmaya ait kayƒ±t bulunamadƒ±.</td></tr>";
            document.getElementById('genelToplam').innerText = "0.00 KG";
            return;
        }

        gruplanmisDizi.sort((a,b) => new Date(b.tarih) - new Date(a.tarih)).forEach((g, index) => {
            genelToplamKG += g.toplamKg;
            const rowId = `detail-${index}`;

            body.innerHTML += `
                <tr class="row-main" onclick="toggleLot('${rowId}')">
                    <td>${g.tarih.split('-').reverse().join('.')}</td>
                    <td style="font-weight:bold">${g.firma}</td>
                    <td>${g.cinsi} <i class="fa-solid fa-chevron-down" style="font-size:10px; margin-left:5px; color:var(--primary)"></i></td>
                    <td style="font-weight:bold; color:var(--success)">${g.toplamKg.toLocaleString('tr-TR', {minimumFractionDigits:2})} KG</td>
                    <td class="no-print"><span style="font-size:11px; color:#666">Detay / ƒ∞≈ülem</span></td>
                </tr>
                <tr id="${rowId}" class="lot-detail-row">
                    <td colspan="5">
                        <div class="lot-container">
                            <strong style="display:block; margin-bottom:10px; color:var(--primary); border-bottom:1px solid #eee;">üì¶ LOT BAZLI ƒ∞ƒ∞≈ûLEMLER:</strong>
                            ${g.lotlar.map(l => `
                                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px dashed #ddd;">
                                    <span><span class="lot-badge">LOT: ${l.lot}</span> ${l.tarih.split('-').reverse().join('.')}</span>
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <b style="color:var(--secondary); min-width:80px; text-align:right;">${l.kg.toLocaleString('tr-TR', {minimumFractionDigits:2})} KG</b>
                                        <div class="no-print">
                                            <button class="btn-plus" onclick="event.stopPropagation(); miktarDegistir('${l.id}', 'artir')" title="Miktar Ekle"><i class="fa-solid fa-plus"></i></button>
                                            <button class="btn-minus" onclick="event.stopPropagation(); miktarDegistir('${l.id}', 'azalt')" title="Miktar D√º≈ü"><i class="fa-solid fa-minus"></i></button>
                                            <button onclick="event.stopPropagation(); duzenle('${l.id}')" style="background:none; border:none; cursor:pointer; margin-left:10px;" title="D√ºzenle">‚úèÔ∏è</button>
                                            <button onclick="event.stopPropagation(); sil('${l.id}')" style="background:none; border:none; cursor:pointer;" title="Sil">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </td>
                </tr>
            `;
        });
        document.getElementById('genelToplam').innerText = genelToplamKG.toLocaleString('tr-TR', {minimumFractionDigits:2}) + " KG";
    }

    function miktarDegistir(id, islem) {
        const miktar = prompt(islem === 'artir' ? "Eklenecek Miktarƒ± Girin (KG):" : "D√º≈ü√ºlecek Miktarƒ± Girin (KG):");
        if (miktar === null || miktar === "" || isNaN(miktar)) return;
        
        const degisim = parseFloat(miktar);
        if (degisim <= 0) return alert("L√ºtfen ge√ßerli bir miktar girin!");

        iplikRef.child(id).once("value", (snap) => {
            const mevcut = snap.val().kg || 0;
            let yeniMiktar = (islem === 'artir') ? mevcut + degisim : mevcut - degisim;
            
            if (yeniMiktar < 0 && !confirm("Stok eksiye d√º≈üecek. Devam edilsin mi?")) return;

            iplikRef.child(id).update({ kg: yeniMiktar });
        });
    }

    function toggleLot(id) {
        const el = document.getElementById(id);
        const isVisible = el.style.display === "table-row";
        document.querySelectorAll('.lot-detail-row').forEach(row => row.style.display = 'none');
        el.style.display = isVisible ? "none" : "table-row";
    }

    function filtreGuncelle(data) {
        if(!data) return;
        const select = document.getElementById('filtre_firma');
        const secili = select.value || "T√úM√ú";
        const firmalar = [...new Set(Object.values(data).map(v => v.firma))].sort();
        
        select.innerHTML = '<option value="T√úM√ú">T√ºm Firmalar</option>';
        firmalar.forEach(f => {
            select.innerHTML += `<option value="${f}" ${f === secili ? 'selected' : ''}>${f}</option>`;
        });
    }

    function duzenle(id) {
        iplikRef.child(id).once("value", (snap) => {
            const s = snap.val();
            document.getElementById('edit_id').value = id;
            document.getElementById('inp_firma').value = s.firma;
            document.getElementById('inp_cinsi').value = s.cinsi;
            document.getElementById('inp_lot').value = s.lot;
            document.getElementById('inp_kg').value = s.kg;
            document.getElementById('inp_tarih').value = s.tarih;
            document.getElementById('formBaslik').innerText = "‚úèÔ∏è Kaydƒ± D√ºzenle";
            document.getElementById('btn_ana').innerText = "G√úNCELLE";
            document.getElementById('btn_iptal').style.display = "inline-block";
            window.scrollTo({top: 0, behavior: 'smooth'});
        });
    }

    function sil(id) {
        if(confirm("Bu iplik stoƒüunu silmek istediƒüinize emin misiniz?")) {
            iplikRef.child(id).remove();
        }
    }

    function formuTemizle() {
        document.getElementById('edit_id').value = "";
        document.querySelectorAll('.form-satir input').forEach(i => { if(i.type !== 'date') i.value = ""; });
        document.getElementById('inp_cinsi').value = "";
        document.getElementById('formBaslik').innerText = "‚ûï Yeni ƒ∞plik Giri≈üi";
        document.getElementById('btn_ana').innerText = "BULUTA KAYDET";
        document.getElementById('btn_iptal').style.display = "none";
    }
</script>
</body>
</html>
