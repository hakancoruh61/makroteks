<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İplik Kompozisyon v5.0 - Gelişmiş Hesaplama</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --accent-color: #28a745;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --border-color: #dee2e6;
        }

        /* PC EKRANI İÇİN KÜÇÜLTME AYARI */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            padding: 10px; 
            background-color: var(--bg-light); 
            color: #343a40;
            zoom: 0.85; /* Sayfayı %85 oranında küçültür */
        }

        .container { 
            max-width: 950px; /* Genişliği daraltarak toplu durmasını sağladık */
            margin: auto; 
            background: var(--bg-white); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
        }
        
        h1 { font-size: 22px; margin-bottom: 10px; }
        h2 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-top: 20px; font-size: 18px; }
        
        .converter-box { display: flex; justify-content: center; gap: 20px; background: #e9ecef; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ced4da; }
        .conv-input { width: 80px; padding: 6px; border-radius: 5px; border: 1px solid #adb5bd; font-weight: bold; text-align: center; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 13px; }
        th, td { padding: 8px; border: 1px solid var(--border-color); text-align: center; }
        th { background-color: var(--primary-color); color: white; text-transform: uppercase; }
        input[type="text"], input[type="number"] { width: 90%; padding: 6px; border: 1px solid #ced4da; border-radius: 5px; text-align: center; font-size: 13px; }

        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; margin: 3px; font-size: 12px; }
        .btn-add { background: var(--primary-color); color: white; }
        .btn-calc { background: var(--accent-color); color: white; font-size: 1rem; width: 100%; margin-top: 15px; }
        .btn-danger { background: #dc3545; color: white; padding: 5px 10px; }
        .btn-save { background: #6f42c1; color: white; }

        .yuzde-kutusu { font-weight: 800; color: #1e3a8a; background: #dbeafe; padding: 4px; border-radius: 4px; display: block; min-height: 18px; }

        #sonuc-alani { margin-top: 20px; padding: 15px; border: 2px solid var(--accent-color); border-radius: 10px; background-color: #f0fff4; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background: #fff; margin-bottom: 5px; border-radius: 5px; font-size: 13px; }
        
        #connStatus { float: right; font-size: 11px; color: green; font-weight: bold; }

        /* YAZDIRMA SIRASINDA KÜÇÜLTME İPTAL EDİLİR (Netlik için) */
        @media print { 
            body { zoom: 1; padding: 0; }
            .no-print { display: none !important; } 
            .container { max-width: 100%; box-shadow: none; border: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="connStatus">● Bulut Aktif</div>
    <h1 style="text-align: center; color: var(--primary-color);">İPLİK KOMPOZİSYON HESAPLAMA</h1>

    <div class="converter-box no-print">
        <div>NE: <input type="number" id="inputNe" class="conv-input" oninput="convert('ne')"></div>
        <div style="font-size: 20px; align-self: center;">⇄</div>
        <div>DENYE: <input type="number" id="inputDenye" class="conv-input" oninput="convert('denye')"></div>
    </div>

    <h2>Kumaş İçeriği (İplikler)</h2>
    <table id="iplik-tablosu">
        <thead>
            <tr>
                <th>İplik Adı</th>
                <th>No (Ne/Denye)</th>
                <th>CM</th>
                <th>Sistem Adeti</th>
                <th>% ORAN</th>
                <th class="no-print">İşlem</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    
    <div class="no-print" style="display:flex; gap:8px; margin-top: 10px;">
        <button class="btn btn-add" onclick="satirEkle()">+ Yeni İplik Ekle</button>
        <button class="btn btn-save" onclick="bulutaKaydet()">☁️ Buluta Kaydet</button>
    </div>

    <button class="btn btn-calc no-print" onclick="hesapla()">HESAPLA VE ANALİZ ET</button>

    <div id="sonuc-alani" style="display:none;">
        <h3 style="margin:0; color: var(--accent-color); font-size: 16px;">Karışım Analizi:</h3>
        <div id="sonuc-metni" style="font-size: 1.1rem; line-height: 1.4;"></div>
        <button class="btn no-print" style="margin-top:10px; background: var(--secondary-color); color: white;" onclick="window.print()">YAZDIR / PDF</button>
    </div>

    <h2 class="no-print">Bulut Kayıt Arşivi</h2>
    <div id="gecmis-listesi" class="no-print"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB4zJ0nY_06VnOh-JEmpfhw8EzrvbCiIBA",
        authDomain: "texerp-ea015.firebaseapp.com",
        databaseURL: "https://texerp-ea015-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "texerp-ea015"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const oranRef = db.ref("iplik_kompozisyonlari");

    function convert(type) {
        const ne = document.getElementById('inputNe');
        const denye = document.getElementById('inputDenye');
        if(type === 'ne') denye.value = Math.round(5315 / ne.value);
        else ne.value = (5315 / denye.value).toFixed(1);
    }

    function satirEkle(veri = {ad: '', no: '', kat: '', oran: ''}) {
        const tbody = document.querySelector('#iplik-tablosu tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="i-ad" value="${veri.ad}" placeholder="Pamuk"></td>
            <td><input type="number" class="i-no" value="${veri.no}" placeholder="30"></td>
            <td><input type="number" class="i-kat" value="${veri.kat}" placeholder="30"></td>
            <td><input type="number" class="i-oran" value="${veri.oran}" placeholder="96"></td>
            <td><span class="yuzde-kutusu">-</span></td>
            <td class="no-print"><button class="btn btn-danger" onclick="this.parentElement.parentElement.remove()">SİL</button></td>
        `;
        tbody.appendChild(tr);
    }

    function hesapla() {
        const satirlar = document.querySelectorAll('#iplik-tablosu tbody tr');
        let toplamAgirlik = 0;
        let bilesenler = [];

        satirlar.forEach(tr => {
            const ad = tr.querySelector('.i-ad').value;
            const no = parseFloat(tr.querySelector('.i-no').value);
            const cm = parseFloat(tr.querySelector('.i-kat').value);
            const sistemAdet = parseFloat(tr.querySelector('.i-oran').value);

            if (ad && no && sistemAdet && cm) {
                const agirlik = (cm * sistemAdet) / no;
                toplamAgirlik += agirlik;
                bilesenler.push({ tr, ad, agirlik });
            }
        });

        if (bilesenler.length === 0) return alert("Verileri girin!");

        let sonucHTML = "<strong>Kumaş Kompozisyonu:</strong><br><ul>";
        bilesenler.forEach(b => {
            const yuzde = ((b.agirlik / toplamAgirlik) * 100).toFixed(1);
            b.tr.querySelector('.yuzde-kutusu').innerText = "% " + yuzde;
            sonucHTML += `<li>%${yuzde} ${b.ad.toUpperCase()}</li>`;
        });
        sonucHTML += "</ul>";
        document.getElementById('sonuc-metni').innerHTML = sonucHTML;
        document.getElementById('sonuc-alani').style.display = 'block';
    }

    function bulutaKaydet() {
        const baslik = prompt("Kayıt başlığı:");
        if(!baslik) return;
        const satirlar = document.querySelectorAll('#iplik-tablosu tbody tr');
        let veriler = [];
        satirlar.forEach(tr => {
            veriler.push({
                ad: tr.querySelector('.i-ad').value,
                no: tr.querySelector('.i-no').value,
                kat: tr.querySelector('.i-kat').value,
                oran: tr.querySelector('.i-oran').value
            });
        });
        oranRef.push({
            baslik: baslik,
            tarih: new Date().toLocaleString('tr-TR'),
            timestamp: Date.now(),
            veriler: veriler
        }).then(() => alert("Kaydedildi!"));
    }

    oranRef.on("value", (snap) => {
        const liste = document.getElementById('gecmis-listesi');
        liste.innerHTML = "";
        const data = snap.val();
        if(!data) return;
        Object.keys(data).map(k => ({id: k, ...data[k]}))
            .sort((a,b) => b.timestamp - a.timestamp)
            .forEach(k => {
                liste.innerHTML += `
                    <div class="history-item">
                        <div><b>${k.baslik}</b><br><small>${k.tarih}</small></div>
                        <div>
                            <button class="btn btn-add" style="background:#17a2b8" onclick="yukle('${k.id}')">YÜKLE</button>
                            <button class="btn btn-danger" onclick="buluttanSil('${k.id}')">SİL</button>
                        </div>
                    </div>`;
            });
    });

    function yukle(id) {
        oranRef.child(id).once("value", (snap) => {
            const k = snap.val();
            const tbody = document.querySelector('#iplik-tablosu tbody');
            tbody.innerHTML = '';
            k.veriler.forEach(v => satirEkle(v));
            hesapla();
        });
    }

    function buluttanSil(id) {
        if(confirm("Silinsin mi?")) oranRef.child(id).remove();
    }

    satirEkle(); satirEkle();
</script>
</body>
</html>
