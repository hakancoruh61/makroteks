<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°plik Kompozisyon v3.0 - Firebase Bulut KayÄ±tlÄ±</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --accent-color: #28a745;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --border-color: #dee2e6;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: var(--bg-light); color: #343a40; }
        .container { max-width: 1100px; margin: auto; background: var(--bg-white); padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        h2 { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; margin-top: 30px; }
        
        .converter-box { display: flex; justify-content: space-around; align-items: center; gap: 30px; padding: 20px; background-color: #e9f2ff; border-radius: 8px; margin-bottom: 20px; }
        .converter-input { flex: 1; text-align: center; }
        .converter-input input { width: 90%; padding: 10px; font-size: 1.1em; text-align: center; border: 1px solid var(--border-color); border-radius: 6px; }

        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: white; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; }
        th { background-color: var(--primary-color); color: white; font-size: 0.9em; }
        input[type="text"], input[type="number"] { width: 95%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
        
        .total-row td { font-weight: bold; background-color: #d1ecf1; color: #0c5460; }

        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; transition: 0.3s; }
        .btn-add { background-color: var(--accent-color); color: white; }
        .btn-save { background-color: #17a2b8; color: white; flex: 1; font-size: 1.1em; }
        .btn-clear { background-color: #dc3545; color: white; }
        button:hover { opacity: 0.8; }

        .history-section { margin-top: 50px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .history-card { background: #fdfdfd; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .history-date { font-weight: bold; color: #555; }
        .history-details { font-size: 0.85em; color: #666; font-style: italic; }
        .history-actions { display: flex; gap: 10px; }
        .btn-load { background-color: #f1c40f; color: #333; padding: 5px 15px; }
        .btn-delete-log { background-color: #e74c3c; color: white; padding: 5px 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“ Ä°plik Numara Ã‡evirici</h2>
    <div class="converter-box">
        <div class="converter-input">
            <label>Denye (D)</label>
            <input type="number" id="input-denye" oninput="convertDenyeToNe()">
        </div>
        <div style="font-size: 2em; color: var(--primary-color);">â‡†</div>
        <div class="converter-input">
            <label>Ä°ngiliz Pamuk (Ne)</label>
            <input type="number" id="input-ne" oninput="convertNeToDenye()">
        </div>
    </div>

    <h2>ğŸ§µ Kompozisyon Hesaplama</h2>
    <table id="iplik-tablosu">
        <thead>
            <tr>
                <th>Ä°plik AdÄ± / TanÄ±mÄ±</th>
                <th>Ä°plik No (Ne)</th>
                <th>50 May (CM)</th>
                <th>Ä°ÄŸne SayÄ±sÄ± (Adet)</th>
                <th>Oran %</th>
                <th>Ä°ÅŸlem</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="4" style="text-align: right;">TOPLAM:</td>
                <td id="toplam-sarfiyat-yuzdesi">0.00 %</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <div class="btn-group">
        <button class="btn-add" onclick="satirEkle()">â• Yeni SatÄ±r</button>
        <button class="btn-save" onclick="hesaplamayiBulutaKaydet()">â˜ï¸ HESAPLAMAYI BULUTA KAYDET</button>
        <button class="btn-clear" onclick="tabloyuSifirla()">ğŸ—‘ï¸ Temizle</button>
    </div>

    <div class="history-section">
        <h2>ğŸ“œ Bulut KayÄ±t GeÃ§miÅŸi</h2>
        <div id="gecmis-listesi">YÃ¼kleniyor...</div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<script>
    // Depostok.html'den alÄ±nan Firebase Bilgileri
    const firebaseConfig = {
        apiKey: "AIzaSyAeFLhVyrv4sn4k JmUtusLIOPWwgmKxe5c",
        authDomain: "kumastakip-6930a.firebaseapp.com",
        databaseURL: "https://kumastakip-6930a-default-rtdb.firebaseio.com",
        projectId: "kumastakip-6930a",
        storageBucket: "kumastakip-6930a.firebasestorage.app",
        messagingSenderId: "796676836408",
        appId: "1:796676836408:web:cf74345b2a412cb1c26acd"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const oranRef = db.ref('kompozisyon_kayitlari'); // Veriler bu baÅŸlÄ±kta toplanacak

    const NE_DENYE_SABITI = 5315;
    let bulutVerileri = {};

    document.addEventListener('DOMContentLoaded', () => {
        satirEkle({adi: 'Pamuk Penye 30/1 Ne', num: 30, may: 16, adet: 96});
        verileriDinle();
    });

    // Firebase'den verileri canlÄ± Ã§ekme
    function verileriDinle() {
        oranRef.on('value', (snapshot) => {
            bulutVerileri = snapshot.val() || {};
            gecmisiListele();
        });
    }

    function satirEkle(v = null) {
        const tbody = document.querySelector('#iplik-tablosu tbody');
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><input type="text" class="iplik-adi" value="${v ? v.adi : ''}" oninput="hesapla()"></td>
            <td><input type="number" step="0.01" class="iplik-num" value="${v ? v.num : 0}" oninput="hesapla()"></td>
            <td><input type="number" step="0.001" class="may-cm" value="${v ? v.may : 0}" oninput="hesapla()"></td>
            <td><input type="number" step="1" class="kullanilan-adet" value="${v ? v.adet : 0}" oninput="hesapla()"></td>
            <td class="sarfiyat-yuzdesi" style="font-weight:bold;">0.00 %</td>
            <td><button onclick="this.parentElement.parentElement.remove(); hesapla();" style="background:none; color:red; font-size:1.2em;">âœ–</button></td>
        `;
        hesapla();
    }

    function hesapla() {
        const rows = document.querySelectorAll('#iplik-tablosu tbody tr');
        let toplamSarfiyat = 0;
        let veriler = [];

        rows.forEach(row => {
            const num = parseFloat(row.querySelector('.iplik-num').value) || 0;
            const may = parseFloat(row.querySelector('.may-cm').value) || 0;
            const adet = parseFloat(row.querySelector('.kullanilan-adet').value) || 0;
            const sarfiyat = num > 0 ? (may / num) * adet : 0;
            veriler.push(sarfiyat);
            toplamSarfiyat += sarfiyat;
        });

        rows.forEach((row, i) => {
            let yuzde = toplamSarfiyat > 0 ? (veriler[i] / toplamSarfiyat) * 100 : 0;
            row.querySelector('.sarfiyat-yuzdesi').textContent = yuzde.toFixed(2) + " %";
        });
        document.getElementById('toplam-sarfiyat-yuzdesi').textContent = (toplamSarfiyat > 0 ? "100.00 %" : "0.00 %");
    }

    // --- FIREBASE KAYIT ---
    function hesaplamayiBulutaKaydet() {
        const rows = document.querySelectorAll('#iplik-tablosu tbody tr');
        if(rows.length === 0) return;

        const iplikler = [];
        rows.forEach(row => {
            iplikler.push({
                adi: row.querySelector('.iplik-adi').value,
                num: row.querySelector('.iplik-num').value,
                may: row.querySelector('.may-cm').value,
                adet: row.querySelector('.kullanilan-adet').value,
                yuzde: row.querySelector('.sarfiyat-yuzdesi').textContent
            });
        });

        const yeniKayit = {
            tarih: new Date().toLocaleString('tr-TR'),
            veriler: iplikler,
            timestamp: Date.now()
        };

        oranRef.push(yeniKayit).then(() => {
            alert("Hesaplama bulut veritabanÄ±na kaydedildi!");
        });
    }

    function gecmisiListele() {
        const liste = document.getElementById('gecmis-listesi');
        const ids = Object.keys(bulutVerileri).reverse(); // En yeni en Ã¼stte
        
        liste.innerHTML = ids.length === 0 ? '<p style="color:#999;">HenÃ¼z kayÄ±tlÄ± hesaplama yok.</p>' : '';

        ids.forEach(id => {
            const kayit = bulutVerileri[id];
            const detay = kayit.veriler.map(i => `${i.adi} (%${i.yuzde})`).join(', ');
            liste.innerHTML += `
                <div class="history-card">
                    <div class="history-header">
                        <span class="history-date">ğŸ“… ${kayit.tarih}</span>
                        <div class="history-actions">
                            <button class="btn-load" onclick="kayitYukle('${id}')">ğŸ”„ GÃ¼ncelle / YÃ¼kle</button>
                            <button class="btn-delete-log" onclick="kayitSil('${id}')">ğŸ—‘ï¸ Sil</button>
                        </div>
                    </div>
                    <div class="history-details">${detay}</div>
                </div>
            `;
        });
    }

    function kayitYukle(id) {
        const kayit = bulutVerileri[id];
        if(!kayit) return;

        if(confirm("Mevcut tablo temizlenecek ve bu bulut kaydÄ± yÃ¼klenecek. OnaylÄ±yor musunuz?")) {
            const tbody = document.querySelector('#iplik-tablosu tbody');
            tbody.innerHTML = '';
            kayit.veriler.forEach(i => satirEkle(i));
            window.scrollTo({top: 0, behavior: 'smooth'});
        }
    }

    function kayitSil(id) {
        if(confirm("Bu kaydÄ± buluttan kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?")) {
            oranRef.child(id).remove();
        }
    }

    function tabloyuSifirla() {
        if(confirm("TÃ¼m satÄ±rlarÄ± temizlemek istediÄŸinize emin misiniz?")) {
            document.querySelector('#iplik-tablosu tbody').innerHTML = '';
            hesapla();
        }
    }

    function convertDenyeToNe() {
        const d = document.getElementById('input-denye').value;
        if (d > 0) document.getElementById('input-ne').value = (NE_DENYE_SABITI / d).toFixed(2);
    }
    function convertNeToDenye() {
        const ne = document.getElementById('input-ne').value;
        if (ne > 0) document.getElementById('input-denye').value = (NE_DENYE_SABITI / ne).toFixed(2);
    }
</script>

</body>
</html>